<discount-field class="discount-field"
  data-discount="{%- for discount in cart.discount_applications -%}
    {%- if discount.type == 'discount_code' -%}{{ discount.title }}{%- endif -%}
    {%- unless forloop.last -%},{%- endunless -%}
  {%- endfor -%}">

  <form class="discount-field__form">
    <input
      type="text"
      name="discount"
      autocomplete="off"
      placeholder="Enter discount code"
      class="discount-field__input">

    <button type="submit" class="discount-field__submit-btn">
      <span class="btn-text">Apply</span>
      <span class="btn-loader" aria-hidden="true"></span>
    </button>
  </form>

  <!-- ‚úÖ Applied discount display -->
  <div class="discount-applied" hidden>
    <div class="discount-applied__label"><span><img src="https://cdn.shopify.com/s/files/1/0752/8015/4881/files/discount-icon.svg?v=1768204649" alt=""></span>Discount:</div>
    <div class="discount-applied__code">
      <strong class="discount-applied__code"></strong>
    </div>
  </div>

  <p class="discount-helper-text">
    Discount codes can be changed at checkout.
  </p>
</discount-field>




<script>
    document.addEventListener('DOMContentLoaded', function () {
  setTimeout(() => {
    class DiscountField extends HTMLElement {
      constructor() {
        super();

        this.form = this.querySelector('.discount-field__form');
        this.input = this.querySelector('input[name="discount"]');
        this.submitButton = this.querySelector('.discount-field__submit-btn');

        this.appliedBox = this.querySelector('.discount-applied');
        this.appliedCodeEl = this.querySelector('.discount-applied__code');

        this.form.addEventListener('submit', this.handleApplyDiscount.bind(this));

        this.syncAppliedState();
      }

      syncAppliedState() {
        const appliedCode = this.dataset.discount?.trim();

        if (appliedCode) {
            // Show applied code
            this.appliedBox.hidden = false;
            this.appliedCodeEl.textContent = appliedCode;
        } else {
            // No discount applied
            this.appliedBox.hidden = true;
            this.appliedCodeEl.textContent = '';
        }
      }

      handleApplyDiscount(e) {
        e.preventDefault();

        const discountCode = this.input.value.trim();
        if (!discountCode) return;

        this.applyDiscountInBackground(discountCode);
      }

      async applyDiscountInBackground(discountCode) {
        this.setLoading(true);

        try {
          console.log(`üéü Applying discount: ${discountCode}`);

          // Apply discount (Shopify-supported)
          await fetch(
            `/discount/${encodeURIComponent(discountCode)}?redirect=/checkout`,
            { method: 'GET', credentials: 'include' }
          );

          // Give Shopify a moment
          await new Promise(resolve => setTimeout(resolve, 800));

          // Refresh cart (totals, loader, checkout amount)
          if (typeof window.initializeCartFunction === 'function') {
            window.initializeCartFunction();
          }

          this.syncAppliedState();

          this.input.value = '';
          console.log('‚úÖ Discount applied');

        } catch (error) {
          console.error('‚ùå Error applying discount:', error);
        } finally {
          this.setLoading(false);
        }
      }

      setLoading(isLoading) {
        this.classList.toggle('discount-field__loading', isLoading);
        this.submitButton.disabled = isLoading;
        this.input.disabled = isLoading;
      }
    }

    customElements.define('discount-field', DiscountField);
  }, 1000);
});

</script>