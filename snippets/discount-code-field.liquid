<discount-field class="discount-field">
  <form class="discount-field__form">
    <input
      type="text"
      name="discount"
      placeholder="Discount code"
      class="discount-field__input"
      required
    >
    <button type="submit" class="discount-field__submit-btn">
      Apply
    </button>
  </form>

  <p class="discount-error" hidden>
    Invalid or expired discount code
  </p>

  <ul class="discount-pills" hidden></ul>
</discount-field>





<script>
document.addEventListener('DOMContentLoaded', () => {
  class DiscountField extends HTMLElement {
    constructor() {
      super();

      this.form = this.querySelector('.discount-field__form');
      this.input = this.querySelector('.discount-field__input');
      this.pills = this.querySelector('.discount-pills');

      this.input.addEventListener('input', () => this.hideError());

      this.form.addEventListener('submit', e => {
        e.preventDefault();
        const code = this.input.value.trim();
        if (code) this.applyDiscount(code);
      });
    }

    async applyDiscount(code) {
  try {
    const res = await fetch('/cart/update.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ discount: code || '' })
    });

    const cart = await res.json();

    /* ===============================
       âœ… Horizon-style VALIDATION
       =============================== */

    // â›”ï¸ If code is empty â†’ NEVER show error
    if (!code) {
      this.hideError();
    } else {
      const isValid =
        cart.discount_codes?.some(d => d.applicable === true);

      if (!isValid) {
        this.showError();   // âŒ invalid / expired code
      } else {
        this.hideError();   // âœ… valid code
      }
    }

    /* ===============================
       ðŸ” UI updates (LOCAL)
       =============================== */

    this.updateFromCart(cart);
    this.input.value = '';

    /* ===============================
       ðŸ”” GLOBAL CART SYNC (NEW)
       =============================== */

    document.dispatchEvent(
      new CustomEvent('cart:updated', { detail: cart })
    );

  } catch (err) {
    console.error('Discount error', err);
    this.showError();
  }
}



    updateFromCart(cart) {
      const codes = new Set();

      cart.cart_level_discount_applications?.forEach(d => {
        if (d.type === 'discount_code') codes.add(d.title);
      });

      cart.items.forEach(item => {
        item.line_level_discount_allocations?.forEach(a => {
          if (a.discount_application.type === 'discount_code') {
            codes.add(a.discount_application.title);
          }
        });
      });

      this.renderPills([...codes]);
    }

    showError() {
      this.querySelector('.discount-error')?.removeAttribute('hidden');
    }

    hideError() {
      this.querySelector('.discount-error')?.setAttribute('hidden', '');
    }

    renderPills(codes) {
      this.pills.innerHTML = '';

      if (!codes.length) {
        this.pills.hidden = true;
        return;
      }

      this.pills.hidden = false;

      codes.forEach(code => {
        const li = document.createElement('li');
        li.className = 'discount-pill';
        li.innerHTML = `
          <div class="discount-text"><span><img src="https://cdn.shopify.com/s/files/1/0752/8015/4881/files/discount-icon.svg?v=1768204649"/></span>Discount: ${code}</div>
          <button type="button" aria-label="Remove">Remove</button>
        `;

        li.querySelector('button').addEventListener('click', () => {
          this.applyDiscount('');
        });

        this.pills.appendChild(li);
      });
    }
  }

  customElements.define('discount-field', DiscountField);
});
</script>
