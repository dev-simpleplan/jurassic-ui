{% assign default_variant = nil %}

{% for variant in product.variants %}
  {% if variant.metafields.custom.is_prior == true and variant.available %}
    {% assign default_variant = variant %}
    {% break %}
  {% endif %}
{% endfor %}

{% if default_variant == nil %}
  {% for variant in product.variants %}
    {% if variant.available %}
      {% assign default_variant = variant %}
      {% break %}
    {% endif %}
  {% endfor %}
{% endif %}

{% if default_variant == nil %}
  {% assign default_variant = product.variants.first %}
{% endif %}

<div class="product-card-primary">
  <div class="fruits_card">
      <div class="fc_top">
        <a href="{{ product.url }}" class="card-link"></a>
        {% assign images = product.images %}

        <div class="fc_image">
          {% if images.size > 0 %}
            <img
              src="{{ images.first | img_url: 'master' }}"
              alt="{{ product.title | escape }}"
              class="img_sizing primary-img">

            {% if images.size > 1 %}
              <img
                src="{{ images[1] | img_url: 'master' }}"
                alt="{{ product.title | escape }}"
                class="img_sizing hover-img">
            {% endif %}
          {% else %}
            <img
              src="{{ 'https://cdn.shopify.com/s/files/1/0752/8015/4881/files/jf-placeholder.png?v=1769522647' }}"
              alt="No Image Available"
              class="img_sizing primary-img">
          {% endif %}
        </div>


        {% assign product_tags = product.tags | downcase %}
        {% if product.tags.size > 0 %}
          <div class="fc_category_tags">
            {% for tag in product.tags %}
              {% unless tag == 'Best Seller' %}
                <span>{{ tag }}</span>
              {% endunless %}
            {% endfor %}
          </div>
        {% endif %}

        {% if product.tags contains 'Best Seller' %}
          <div class="fc_bestsell_tags">
            <span>Bestseller</span>
          </div>
        {% endif %}

        {% if product.metafields.custom.certificate %}
          {% assign certificate = product.metafields.custom.certificate.value %}
          {% for item in product.metafields.custom.certificate.value %}
            <div class="fc_organic_auth">
              <img
                src="{{ item.badge_image | img_url:'master' }}"
                alt="{{ item.display_name }}"
                class="img_sizing">
            </div>
          {% endfor %}
        {% endif %}
      </div>

    <div class="fc_bottom_outer">
      <div class="fc_bottom">

        <div class="fc_bottom_top">
          <div class="star_review">
            <div class="star_rating">
              <p data-oke-star-rating data-oke-reviews-product-id="shopify-{{ product.id }}"></p>
            </div>
            <div class="rating_info">
              <span class="dot_seperator dynamic-review-dot"></span>
              <p>{{ product.metafields.custom.country_of_origin.value.country_name }}</p>
            </div>
          </div>
          <p class="fc_product_title">
            <a href="{{ product.url }}">{{ product.title | truncate: 50 }}</a>
          </p>
          
        </div>

        <div class="fc_bottom_bottom">
          <div class="fc_bottom_center">
            <div class="fc_variant_outer">
              <div class="fc_variant_wrap">
                {% for variant in product.variants %}
                  <script type="application/JSON">
                    {{ variant | json }}
                  </script>

                  {% assign pieces = 0 %}
                  {% if variant.unit_price_measurement
                    and variant.unit_price_measurement.quantity_value != blank %}
                    {% assign pieces = variant.unit_price_measurement.quantity_value | round %}
                  {% endif %}

                  <div
                    class="fc_variant_item
                    {% if variant.id == default_variant.id %}active{% endif %}
                    {% if variant.metafields.custom.bestseller == true %}bestseller{% endif %}"
                    data-id="{{ variant.id }}"
                    data-price="{{ variant.price | money }}"
                    data-compare="{{ variant.compare_at_price | money }}"
                    data-inventory="{{ variant.inventory_quantity }}"
                    data-unit="{% if variant.unit_price_measurement %}
                      {{ variant.unit_price | money }} / {{ variant.unit_price_measurement.reference_unit }}
                    {% else %}
                      {{ variant.price | money }} / unit
                    {% endif %}"
                    data-image="{{ variant.image | img_url: 'master' }}">
                    {% if variant.metafields.custom.bestseller == true %}
                      <div class="vv-bestseller">Bestseller</div>
                    {% endif %}
                    <p class="weight">
                      {{ variant.title }}
                      {% if variant.compare_at_price > variant.price %}
                        <span>
                          {{
                            variant.compare_at_price | minus: variant.price | times: 100 | divided_by: variant.compare_at_price | round
                          -}}
                          % Off
                        </span>
                      {% endif %}
                    </p>
                    <p class="quantity">
                      {% if variant.unit_price_measurement
                        and variant.unit_price_measurement.quantity_value != blank %}
                        
                        {% assign pieces = variant.unit_price_measurement.quantity_value | round %}
                        
                        {{ pieces }}
                        {% if pieces == 1 %} Piece{% else %} Pieces{% endif %}
                        
                      {% else %}
                        0 Pieces
                      {% endif %}
                    </p>

                  </div>
                {% endfor %}
              </div>
              <div class="selected_variant_dropdown"></div>
            </div>
          </div>

          <div class="fc_bottom_end">
            <div class="fc_price_weight">
              {% assign current_variant = nil %}
              {% assign current_variant = default_variant %}

              {% if current_variant.compare_at_price > current_variant.price %}
                <p>
                  <strike id="compare_price">{{ current_variant.compare_at_price | money }}</strike>
                  <span class="selling_price">{{ current_variant.price | money }}</span>
                </p>
              {% else %}
                <p>
                  <span class="selling_price">{{ current_variant.price | money }}</span>
                </p>
              {% endif %}

              <p class="fc_weight">
                {% if current_variant.unit_price_measurement %}
                  {% comment %} 
                    If Shopify has unit price data, use the official unit_price.
                    This handles kg, g, ml, etc., automatically.
                  {% endcomment %}
                  {{ current_variant.unit_price | money }} / {{ current_variant.unit_price_measurement.reference_unit }}
                {% else %}
                  {% comment %} 
                    Fallback if no unit price is defined in Shopify Admin 
                  {% endcomment %}
                  {{ current_variant.price | money }} / unit
                {% endif %}
              </p>


            </div>
            <div class="fc_add_to_cart_outer">
                <div class="fc_add_to_cart"
                  data-variant-id="{{ current_variant.id }}"
                  data-available="{{ current_variant.available }}"
                  data-inventory="{{ current_variant.inventory_quantity }}"
                  data-external-add>

                  <button
                    type="button"
                    class="add-to-cart-btn"
                    {% unless current_variant.available %}disabled{% endunless %}>
                    {% if current_variant.available %}Add to Cart{% else %}Sold Out{% endif %}
                  </button>
                  {% unless product.available %}
                    <a href="#" class="BIS_trigger" 
                      data-product-handle="{{ product | json | escape }}" 
                      data-variant-id="{{ current_variant.id }}">
                      Email when available
                    </a>
                  {% endunless %}
                </div>
            </div>
            <div class="fc_trust_text">
              <p class="{% if current_variant.inventory_quantity < 10 %}low-stock{% endif %}">
                Only {{ current_variant.inventory_quantity }} Left
              </p>
              <span class="dot_seperator"></span>
              <p>Ships in 24 hrs</p>
              <span class="dot_seperator"></span>
              <p>{{ product.metafields.custom.benefit | default: 'Product Benefit' }}</p>
            </div>
          </div>
        </div>


      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  async function addToCart(id, qty = 1) {
    return fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, quantity: qty })
    }).then(r => r.json());
  }

  function openSideCartDirectly() {
    const sideCart = document.querySelector('.sideCart');
    if (!sideCart) return;

    sideCart.classList.add('active');
    document.body.classList.add('stay');
    document.documentElement.classList.add('stay');

    // ðŸ”‘ ENSURE CONTENT IS RENDERED
    // ðŸ”‘ Call the correct function from your side cart script
    if (typeof window.loadCartItems === 'function') {
      window.loadCartItems();
    }
  }


  async function updateHeaderCartCount() {
    const cart = await fetch('/cart.js').then(r => r.json());
    const el = document.querySelector('.header__cart-quantity');
    if (!el) return;
    el.textContent = cart.item_count;
    el.classList.toggle('is-hidden', cart.item_count === 0);
  }

  /* ---------------- VARIANT SWITCH ---------------- */
  document.querySelectorAll('.fc_variant_item').forEach(variant => {
    variant.addEventListener('click', () => {
      const card = variant.closest('.product-card-primary');
      if (!card) return;

      // active state
      variant
        .parentElement
        .querySelectorAll('.fc_variant_item')
        .forEach(v => v.classList.remove('active'));

      variant.classList.add('active');

      const variantId = variant.dataset.id;
      const price = variant.dataset.price;
      const compare = variant.dataset.compare;
      const unit = variant.dataset.unit;
      const image = variant.dataset.image;

      // update price
      const priceWrap = card.querySelector('.fc_price_weight');
      if (priceWrap) {
        priceWrap.querySelector('.selling_price').innerText = price;
        const compareEl = priceWrap.querySelector('#compare_price');
        if (compareEl) compareEl.innerText = compare;
      }

      // update image
      const img = card.querySelector('.primary-img');
      if (img && image) img.src = image;

      // update add to cart button variant
      const addWrap = card.querySelector('.fc_add_to_cart');
      if (addWrap) {
        addWrap.dataset.variantId = variantId;
      }
    });
  });

  /* ---------------- ADD TO CART ---------------- */
  document.querySelectorAll('.fc_add_to_cart .add-to-cart-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      e.stopImmediatePropagation();
      const wrap = btn.closest('.fc_add_to_cart');
      if (!wrap) return;

      const variantId = Number(wrap.dataset.variantId);
      if (!variantId) return;

      btn.disabled = true;
      btn.textContent = 'Addingâ€¦';

      try {
        await addToCart(variantId, 1);
        openSideCartDirectly();

        // This is redundant if you fixed the function above, 
        // but it's good practice to call the refresh logic here.
        if (typeof window.loadCartItems === 'function') {
          await window.loadCartItems();
        }

      } catch (err) {
        console.error('Add to cart failed', err);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Add to Cart';
      }
    });
  });

});
</script>
