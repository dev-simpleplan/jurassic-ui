{% assign default_variant = nil %}

{% for variant in product.variants %}
  {% if variant.metafields.custom.is_prior == true and variant.available %}
    {% assign default_variant = variant %}
    {% break %}
  {% endif %}
{% endfor %}

{% if default_variant == nil %}
  {% for variant in product.variants %}
    {% if variant.available %}
      {% assign default_variant = variant %}
      {% break %}
    {% endif %}
  {% endfor %}
{% endif %}

{% if default_variant == nil %}
  {% assign default_variant = product.variants.first %}
{% endif %}

<div class="product-card-primary">
  <div class="fruits_card">
      <div class="fc_top">
        <a href="{{ product.url }}" class="card-link"></a>
        {% assign images = product.images %}

        <div class="fc_image">
          {% if images.size > 0 %}
            <img
              src="{{ images.first | img_url: 'master' }}"
              alt="{{ product.title | escape }}"
              class="img_sizing primary-img">

            {% if images.size > 1 %}
              <img
                src="{{ images[1] | img_url: 'master' }}"
                alt="{{ product.title | escape }}"
                class="img_sizing hover-img">
            {% endif %}
          {% else %}
            <img
              src="{{ 'https://cdn.shopify.com/s/files/1/0752/8015/4881/files/placeholder.jpg?v=1760532683' }}"
              alt="No Image Available"
              class="img_sizing primary-img">
          {% endif %}
        </div>


        {% assign product_tags = product.tags | downcase %}
        {% if product.tags.size > 0 %}
          <div class="fc_category_tags">
            {% for tag in product.tags %}
              {% unless tag == 'Best Seller' %}
                <span>{{ tag }}</span>
              {% endunless %}
            {% endfor %}
          </div>
        {% endif %}

        {% if product.tags contains 'Best Seller' %}
          <div class="fc_bestsell_tags">
            <span>Bestseller</span>
          </div>
        {% endif %}

        {% if product.metafields.custom.certificate %}
          {% assign certificate = product.metafields.custom.certificate.value %}
          {% for item in product.metafields.custom.certificate.value %}
            <div class="fc_organic_auth">
              <img
                src="{{ item.badge_image | img_url:'master' }}"
                alt="{{ item.display_name }}"
                class="img_sizing">
            </div>
          {% endfor %}
        {% endif %}
      </div>

    <div class="fc_bottom_outer">
      <div class="fc_bottom">

        <div class="fc_bottom_top">
          <div class="star_review">
            <div class="star_rating">
              <p data-oke-star-rating data-oke-reviews-product-id="shopify-{{ product.id }}"></p>
            </div>
            <div class="rating_info">
              {% if product.metafields.custom.country_of_origin %}
                <span class="dot_seperator"></span>
                <p>{{ product.metafields.custom.country_of_origin.value.country_name }}</p>
              {% endif %}
            </div>
          </div>
          <p class="fc_product_title">
            <a href="{{ product.url }}">{{ product.title | truncate: 50 }}</a>
          </p>
          
        </div>

        <div class="fc_bottom_bottom">
          <div class="fc_bottom_center">
            <div class="fc_variant_outer">
              <div class="fc_variant_wrap">
                {% for variant in product.variants %}
                  <script type="application/JSON">
                    {{ variant | json }}
                  </script>

                  {% assign pieces = 0 %}
                  {% if variant.unit_price_measurement
                    and variant.unit_price_measurement.quantity_value != blank %}
                    {% assign pieces = variant.unit_price_measurement.quantity_value | round %}
                  {% endif %}

                  {% assign pieces = 0 %}                  
                  <div
                    class="fc_variant_item
                    {% if variant.id == default_variant.id %}active{% endif %}
                    {% if variant.metafields.custom.bestseller == true %}bestseller{% endif %}"
                    data-id="{{ variant.id }}"
                    data-price="{{ variant.price | money }}"
                    data-compare="{{ variant.compare_at_price | money }}"
                    data-inventory="{{ variant.inventory_quantity }}"
                    data-unit="{{ variant.unit_price | money }} / {{ variant.unit_price_measurement.reference_unit }}"
                    data-image="{{ variant.image | img_url: 'master' }}">
                    {% if variant.metafields.custom.bestseller == true %}
                      <div class="vv-bestseller">Bestseller</div>
                    {% endif %}
                    <p class="weight">
                      {{ variant.title }}
                      {% if variant.compare_at_price > variant.price %}
                        <span>
                          {{
                            variant.compare_at_price | minus: variant.price | times: 100 | divided_by: variant.compare_at_price | round
                          -}}
                          % Off
                        </span>
                      {% endif %}
                    </p>
                    <p class="quantity">
                      {% if variant.unit_price_measurement
                        and variant.unit_price_measurement.quantity_value != blank %}
                        
                        {% assign pieces = variant.unit_price_measurement.quantity_value | round %}
                        
                        {{ pieces }}
                        {% if pieces == 1 %} Peice{% else %} Peices{% endif %}
                        
                      {% else %}
                        0 Peices
                      {% endif %}
                    </p>

                  </div>
                {% endfor %}
              </div>
              <div class="selected_variant_dropdown"></div>
            </div>
          </div>

          <div class="fc_bottom_end">
            <div class="fc_price_weight">
              {% assign current_variant = nil %}
              {% for variant in product.variants %}
                {% if variant.metafields.custom.is_prior == true and variant.available %}
                  {% assign current_variant = variant %}
                  {% break %}
                {% endif %}
              {% endfor %}
              {% if current_variant == nil %}
                {% assign current_variant = product.selected_or_first_available_variant %}
              {% endif %}

              {% if current_variant.compare_at_price > current_variant.price %}
                <p>
                  <strike id="compare_price">{{ current_variant.compare_at_price | money }}</strike>
                  <span class="selling_price">{{ current_variant.price | money }}</span>
                </p>
              {% else %}
                <p>
                  <span class="selling_price">{{ current_variant.price | money }}</span>
                </p>
              {% endif %}

              <p class="fc_weight" data-variant-id="{{ current_variant.id }}">
                {% if current_variant.unit_price_measurement %}
                  {{ current_variant.unit_price | money }} /
                  {{ current_variant.unit_price_measurement.reference_unit }}
                {% else %}
                  {{ current_variant.price | money }} / unit
                {% endif %}
              </p>

            </div>
            <div class="fc_add_to_cart_outer">
                <div class="fc_add_to_cart"
                  data-variant-id="{{ current_variant.id }}"
                  data-available="{{ current_variant.available }}"
                  data-inventory="{{ current_variant.inventory_quantity }}">

                  <button
                    type="button"
                    class="add-to-cart-btn"
                    {% unless current_variant.available %}disabled{% endunless %}>
                    {% if current_variant.available %}Add to Cart{% else %}Sold Out{% endif %}
                  </button>

                  <div class="qty-controls">
                    <span class="remove_product">â€“</span>
                    <span class="qty-value">1</span>
                    <span class="add_product">+</span>
                  </div>
                </div>
              </div>
            <div class="fc_trust_text">
              <p>Only {{ current_variant.inventory_quantity }} Left</p>
              <span class="dot_seperator"></span>
              <p>Ships in 24 hrs</p>
              <span class="dot_seperator"></span>
              <p>{{ product.metafields.custom.benefit | default: 'Product Benefit' }}</p>
            </div>
          </div>
        </div>


      </div>
    </div>
  </div>
</div>


<style>

  .fc_add_to_cart {
  display: flex;
  align-items: center;
  gap: 12px;
}

.fc_add_to_cart .remove_product,
.fc_add_to_cart .add_product,
.fc_add_to_cart .qty-value {
  display: none;
}

.fc_add_to_cart.active .remove_product,
.fc_add_to_cart.active .add_product,
.fc_add_to_cart.active .qty-value {
  display: inline-flex;
  justify-content: center;
}

.fc_add_to_cart.active .add-to-cart-btn {
  display: none;
}
.fc_add_to_cart {
  display: flex;
  justify-content: center;
}

.fc_add_to_cart .qty-controls {
  display: none;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  width: 100%;
}

.fc_add_to_cart.active .qty-controls {
  display: flex;
}

.fc_add_to_cart.active .add-to-cart-btn {
  display: none;
}

.qty-controls span {
  cursor: pointer;
  user-select: none;
  font-size: 18px;
  font-weight: 600;
}


</style>

  <script>

document.addEventListener('DOMContentLoaded', () => {

  async function addToCart(id, qty) {
    return fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, quantity: qty })
    }).then(r => r.json());
  }

  async function changeCart(key, qty) {
    return fetch('/cart/change.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: key, quantity: qty })
    });
  }

  async function getCart() {
    return fetch('/cart.js').then(r => r.json());
  }

  // ---------------- SAFE SIDE CART OPEN (NO SCROLL JUMP) ----------------
  function openSideCartDirectly() {
    const sideCart = document.querySelector('.sideCart');
    if (!sideCart) return;

    sideCart.classList.add('active');
    document.body.classList.add('stay');
    // document.documentElement.classList.add('stay');

    // âœ… THIS ACTUALLY WORKS
    window.initializeCartFunction?.();
  }







  // ---------------- HEADER CART COUNT SYNC ----------------
  async function updateHeaderCartCount() {
    const res = await fetch('/cart.js');
    const cart = await res.json();

    const el = document.querySelector('.header__cart-quantity');
    if (!el) return;

    el.textContent = cart.item_count;

    if (cart.item_count > 0) {
      el.classList.remove('is-hidden');
    } else {
      el.classList.add('is-hidden');
    }
  }


  document.querySelectorAll('.fc_add_to_cart').forEach(card => {

  // ðŸ”’ Prevent duplicate bindings
  if (card.dataset.bound === 'true') return;
  card.dataset.bound = 'true';

  if (card.dataset.available !== 'true') return;

  const variantId = Number(card.dataset.variantId);
  const maxQty = parseInt(card.dataset.inventory, 10) || Infinity;

  const addBtn = card.querySelector('.add-to-cart-btn');
  const plus = card.querySelector('.add_product');
  const minus = card.querySelector('.remove_product');
  const qtyEl = card.querySelector('.qty-value');

  let qty = 0;
  let lineKey = null;
  let isLoading = false;

  /* ---------------- ADD TO CART ---------------- */
  addBtn.addEventListener('click', async (e) => {
  e.preventDefault();
  e.stopPropagation();

  if (isLoading) return;
  isLoading = true;

  addBtn.disabled = true;
  addBtn.textContent = 'Addingâ€¦';

  try {
    const cartBefore = await getCart();
    const existing = cartBefore.items.find(
      i => i.variant_id === variantId
    );

    if (existing) {
      await changeCart(existing.key, existing.quantity + 1);
    } else {
      await addToCart(variantId, 1);
    }

    const cartAfter = await getCart();
    const item = cartAfter.items.find(
      i => i.variant_id === variantId
    );

    qty = item.quantity;
    lineKey = item.key;
    qtyEl.textContent = qty;

    requestAnimationFrame(() => {
      card.classList.add('active');
    });

    await updateHeaderCartCount();
    openSideCartDirectly();

  } catch (err) {
    console.error(err);
  } finally {
    isLoading = false;
  }
});



  /* ---------------- PLUS ---------------- */
  plus.addEventListener('click', async (e) => {
    e.preventDefault();
    e.stopPropagation();

    if (isLoading || qty >= maxQty) return;
    isLoading = true;

    qty++;
    qtyEl.textContent = qty;

    await changeCart(lineKey, qty);

    const cart = await getCart();
    await updateHeaderCartCount();

    isLoading = false;
  });

  /* ---------------- MINUS ---------------- */
  minus.addEventListener('click', async (e) => {
    e.preventDefault();
    e.stopPropagation();

    if (isLoading) return;
    isLoading = true;

    qty--;

    if (qty <= 0) {
      await changeCart(lineKey, 0);

      requestAnimationFrame(() => {
        card.classList.remove('active');
      });

      qty = 0;
      isLoading = false;

      const cart = await getCart();
      await updateHeaderCartCount();
      return;
    }

    qtyEl.textContent = qty;
    await changeCart(lineKey, qty);

    const cart = await getCart();
    await updateHeaderCartCount();

    isLoading = false;
  });

});

});
</script>