{% comment %}
  Cart page section for /cart
{% endcomment %}

<section id="cart-page-{{ section.id }}" class="top-wrap cart-page-section">
  <div class="cart-page">
    <div class="container-fluid">
      <div class="cardp-details">
        <div class="cart-header">
          <div class="carthead-left">
            <h1>My {{ 'cart.title' | t }}</h1>
          </div>
          <div class="carthead-right">
            <div class="sch-left">
              <p>
                <span id="cart_item_count">({{ cart.item_count }} items)</span>
              </p>
            </div>
          </div>
        </div>

        <div class="cart-page-data" data-cart-page>
          <div class="cart-page-items-wrapper">
            <div class="cart-page-items" data-cart-page-items></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // üîí Scope everything to THIS section only
    const cartSection = document.getElementById('cart-page-{{ section.id }}');
    if (!cartSection) {
      console.warn('Cart page section not found');
      return;
    }

    const itemsWrapper = cartSection.querySelector('[data-cart-page-items]');
    const cartCountSpan = cartSection.querySelector('#cart_item_count');

    if (!itemsWrapper) {
      console.warn('Cart page items wrapper not found');
      return;
    }

    function formatMoney(cents) {
      if (typeof cents !== 'number') cents = Number(cents) || 0;
      const value = (cents / 100).toFixed(2);
      const symbol = window.currencySymbol || '';
      const code = window.activeCurrency || '';
      return `${symbol}${value} ${code}`;
    }

    // üöö Load & render cart items (cart PAGE only)
    const loadCartPageItems = async () => {
      try {
        console.log('üõí [CartPage] Loading cart items...');
        const res = await fetch((window.Shopify?.routes?.root || '/') + 'cart.js');
        const cart = await res.json();
        console.log('üõí [CartPage] Cart Data:', cart);

        if (!cart.items.length) {
          itemsWrapper.innerHTML = `
            <div class="cart-page-empty">
              <h3>Your cart is empty</h3>
              <p>Add some products to see them here.</p>
            </div>
          `;
          if (cartCountSpan) cartCountSpan.textContent = '(0 items)';
          return;
        }

        const itemsHTML = cart.items.map((item, index) => {
          const line = index + 1;
          const priceEach = item.final_line_price / item.quantity;

          return `
            <div class="cart-page-item" data-line="${line}">
              <div class="cart-page-item-left">
                <div class="cart-page-item-image">
                  <img src="${item.image}" alt="${item.title}" class="cart-image" />
                </div>
                <div class="cart-page-item-info">
                  <p class="cart-item-title">${item.title}</p>
                  <div class="other-cart-info">
                    <div class="oci-item">
                        <div class="oci-label">Unit price</div>
                        <div class="oci-data">
                            <p class="cart-price">
                                ${formatMoney(priceEach)}
                            </p>
                        </div>
                    </div>
                    <div class="oci-item">
                        <div class="oci-label">Unit</div>
                        <div class="oci-data">
                            <div class="cart-page-qty">
                                <button class="cart-page-qty-btn minus" data-line="${index + 1}" data-qty="${item.quantity}">
                                ${item.quantity > 1 ? `{% render 'minus-icon' %}` : `{% render 'bin-icon' %}`}
                                </button>
                                <span class="cart-page-qty-count">${item.quantity}</span>
                                <button class="cart-page-qty-btn plus" data-line="${index + 1}" data-qty="${item.quantity}">
                                {% render 'plus-icon' %}
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="oci-item">
                        <div class="oci-label">Total price</div>
                        <div class="oci-data">
                            <p class="cart-price">
                                ${formatMoney(item.final_line_price)}
                            </p>
                        </div>
                    </div>
                  </div>
                </div>
              </div>
              
              
            </div>
          `;
        }).join('');

        itemsWrapper.innerHTML = itemsHTML;

        // Update item count text
        if (cartCountSpan) {
          cartCountSpan.textContent =
            cart.item_count === 1 ? '(1 item)' : `(${cart.item_count} items)`;
        }

        attachCartPageQtyHandlers();
      } catch (error) {
        console.error('‚ùå [CartPage] Error loading cart items:', error);
        itemsWrapper.innerHTML = '<p>Could not load cart items.</p>';
      }
    };

    // üîÑ Update a cart line (cart PAGE only)
    const updateCartPageItem = async (line, quantity) => {
      try {
        console.log('üîÑ [CartPage] Updating line', line, '‚Üí qty', quantity);
        const res = await fetch((window.Shopify?.routes?.root || '/') + 'cart/change.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ line, quantity })
        });
        const cart = await res.json();
        console.log('‚úÖ [CartPage] Cart updated:', cart);
        await loadCartPageItems();
      } catch (error) {
        console.error('‚ùå [CartPage] Error updating cart item:', error);
      }
    };

    // ‚ûï‚ûñ Qty handlers (cart PAGE only)
    const attachCartPageQtyHandlers = () => {
      const plusBtns = cartSection.querySelectorAll('.cart-page-qty-btn.plus');
      const minusBtns = cartSection.querySelectorAll('.cart-page-qty-btn.minus');

      plusBtns.forEach((btn) => {
        btn.addEventListener('click', () => {
          const line = Number(btn.dataset.line);
          const itemEl = btn.closest('.cart-page-item');
          const qtyEl = itemEl.querySelector('.cart-page-qty-count');
          const currentQty = Number(qtyEl.textContent);
          updateCartPageItem(line, currentQty + 1);
        });
      });

      minusBtns.forEach((btn) => {
        btn.addEventListener('click', () => {
          const line = Number(btn.dataset.line);
          const itemEl = btn.closest('.cart-page-item');
          const qtyEl = itemEl.querySelector('.cart-page-qty-count');
          const currentQty = Number(qtyEl.textContent);
          const newQty = currentQty > 1 ? currentQty - 1 : 0;
          updateCartPageItem(line, newQty);
        });
      });
    };

    // üü¢ Init (cart page only; side cart script will **not** be touched)
    loadCartPageItems();
  });
</script>

{% schema %}
{
  "name": "t:general.cart",
  "settings": []
}
{% endschema %}
