{% comment %}
  Cart page section for /cart
{% endcomment %}

<section id="cart-page-{{ section.id }}" class="top-wrap cart-page-section">
  <div class="cart-page">
    <div class="container-fluid">
      <div class="cardp-details">
        <div class="cart-header">
          <div class="carthead-left">
            <h1>My {{ 'cart.title' | t }}</h1>
            <div class="sch-left">
              <p>
                <span id="cart_item_count">({{ cart.item_count }} items)</span>
              </p>
            </div>
          </div>
          <div class="carthead-right">
            <a href="{{ routes.collections_url }}" class="custom-btn line rounded">continue shopping</a>
          </div>
        </div>

        <div class="cart-page-data" data-cart-page>
          <div class="cart-page-items-wrapper">
            <div class="cart-page-items" data-cart-page-items></div>
          </div>
          <div class="cart-page-details">
                <div class="cpd-footer">
                    <div class="cpd-coupon">
                        <p class="coupon-toggle-text">Have a coupon code?</p>
                        <div class="coupon-field-container" style="display:none;">
                            {% render 'discount-code-field' %}
                        </div>
                    </div>
                    <div class="cart-totals">
                        <div class="cart-subtotal">
                        <p class="cs-title">Subtotal</p>
                        <p class="subtotal-amount cs-res">0.00</p>
                        </div>
                        <div class="cart-shipping">
                        <p class="cs-title">shipping
                            <span>(calc. at the checkout)</span>
                        </p>
                        <p class="shipping-amount cs-res">Calculated at checkout</p>
                        </div>
                        <div class="cart-total">
                        <p class="cs-title">Total
                            <span>incl. VAT</span>
                        </p>
                        <p class="total-amount cs-res">0.00</p>
                        </div>
                    </div>
                    <form action="/checkout" method="post">
                        <button
                        name="checkout"
                        type="submit"
                        class="checkout-btn custom-btn filled"
                        style="width: 100%;">
                        <span class="checkout-txt">Checkout</span>
                        <span class="checkout-total">0.00</span>
                        </button>
                    </form>

                    <div class="cpd-fields-sec">

                    </div>
                </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // üîí Scope everything to THIS section only
    const cartSection = document.getElementById('cart-page-{{ section.id }}');
    if (!cartSection) {
      console.warn('Cart page section not found');
      return;
    }

    const itemsWrapper = cartSection.querySelector('[data-cart-page-items]');
    const cartCountSpan = cartSection.querySelector('#cart_item_count');
    const subtotalDiv = cartSection.querySelector('.subtotal-amount');
    const shippingAmountDiv = cartSection.querySelector('.shipping-amount');
    const totalAmountDivs = cartSection.querySelectorAll('.total-amount, .checkout-total');

    if (!itemsWrapper) {
      console.warn('Cart page items wrapper not found');
      return;
    }

    function formatMoney(cents) {
      if (typeof cents !== 'number') cents = Number(cents) || 0;
      const value = (cents / 100).toFixed(2);
      const symbol = window.currencySymbol || '';
      const code = window.activeCurrency || '';
      return `${symbol}${value} ${code}`;
    }

    // üöö Load & render cart items (cart PAGE only)
    const loadCartPageItems = async () => {
      try {
        console.log('üõí [CartPage] Loading cart items...');
        const res = await fetch((window.Shopify?.routes?.root || '/') + 'cart.js');
        const cart = await res.json();
        console.log('üõí [CartPage] Cart Data:', cart);

        // üßÆ Update subtotal & total
        if (subtotalDiv) {
        subtotalDiv.textContent = formatMoney(cart.items_subtotal_price);
        }

        if (totalAmountDivs && totalAmountDivs.length) {
        totalAmountDivs.forEach(el => {
            el.textContent = formatMoney(cart.total_price);
        });
        }

        if (!cart.items.length) {
          itemsWrapper.innerHTML = `
            <div class="cart-page-empty">
              <h3>Your cart is empty</h3>
              <p>Add some products to see them here.</p>
            </div>
          `;
          if (cartCountSpan) cartCountSpan.textContent = '(0 items)';
          if (subtotalDiv) subtotalDiv.textContent = formatMoney(0);
            if (totalAmountDivs && totalAmountDivs.length) {
                totalAmountDivs.forEach(el => (el.textContent = formatMoney(0)));
            }
          return;
        }

        // üî• ONLY CHANGE: now async per item so we can get compare_at_price
        const itemsHTML = await Promise.all(
          cart.items.map(async (item, index) => {
            const line = index + 1;
            const priceEach = item.final_line_price / item.quantity;

            // --- Get compare_at_price from product JSON ---
            let compareAtPrice = null;

            try {
              const productRes = await fetch(`/products/${item.handle}.js`);
              const productData = await productRes.json();

              const variantData = productData.variants.find(v => v.id === item.variant_id);
              if (variantData && variantData.compare_at_price) {
                compareAtPrice = Number(variantData.compare_at_price); // cents
              }
            } catch (err) {
              console.warn('Unable to load product JSON for discount:', err);
            }

            const hasDiscount =
              compareAtPrice &&
              compareAtPrice > Number(item.final_line_price);

            let discountPercent = 0;
            if (hasDiscount) {
              discountPercent = Math.round(
                ((compareAtPrice - item.final_line_price) / compareAtPrice) * 100
              );
            }

          return `
            <div class="cart-page-item" data-line="${line}">
              <div class="cart-page-item-left">
                <div class="cart-page-item-image">
                  <img src="${item.image}" alt="${item.title}" class="cart-image" />
                </div>
                <div class="cart-page-item-info">
                  <p class="cart-item-title">${item.title}</p>
                  <div class="other-cart-info">
                    <div class="oci-item">
                        <div class="oci-label">Unit price</div>
                        <div class="oci-data">
                            <p class="cart-price">
                                ${formatMoney(priceEach)}
                            </p>
                        </div>
                    </div>
                    <div class="oci-item">
                        <div class="oci-label">Unit</div>
                        <div class="oci-data">
                            <div class="cart-page-qty">
                                <button class="cart-page-qty-btn minus" data-line="${index + 1}" data-qty="${item.quantity}">
                                ${item.quantity > 1 ? `{% render 'minus-icon' %}` : `{% render 'bin-icon' %}`}
                                </button>
                                <span class="cart-page-qty-count">${item.quantity}</span>
                                <button class="cart-page-qty-btn plus" data-line="${index + 1}" data-qty="${item.quantity}">
                                {% render 'plus-icon' %}
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="oci-item">
                        <div class="oci-label">Discount</div>
                        <div class="oci-data">
                            <p class="cart-price">
                                ${
                              hasDiscount
                                ? `<span class="cart-discount-label">${discountPercent}% Off</span>`
                                : ''
                            }
                            </p>
                        </div>
                    </div>
                    <div class="oci-item">
                        <div class="oci-label">Total price</div>
                        <div class="oci-data">
                            <p class="cart-price">
                                ${formatMoney(item.final_line_price)}
                            </p>
                        </div>
                    </div>
                  </div>
                </div>
              </div>
              
              
            </div>
          `;
       })
        );

        itemsWrapper.innerHTML = itemsHTML.join('');

        // Update item count text
        if (cartCountSpan) {
          cartCountSpan.textContent =
            cart.item_count === 1 ? '(1 item)' : `(${cart.item_count} items)`;
        }

        attachCartPageQtyHandlers();
      } catch (error) {
        console.error('‚ùå [CartPage] Error loading cart items:', error);
        itemsWrapper.innerHTML = '<p>Could not load cart items.</p>';
      }
    };

    // üîÑ Update a cart line (cart PAGE only)
    const updateCartPageItem = async (line, quantity) => {
      try {
        console.log('üîÑ [CartPage] Updating line', line, '‚Üí qty', quantity);
        const res = await fetch((window.Shopify?.routes?.root || '/') + 'cart/change.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ line, quantity })
        });
        const cart = await res.json();
        console.log('‚úÖ [CartPage] Cart updated:', cart);
        await loadCartPageItems();
      } catch (error) {
        console.error('‚ùå [CartPage] Error updating cart item:', error);
      }
    };

    // ‚ûï‚ûñ Qty handlers (cart PAGE only)
    const attachCartPageQtyHandlers = () => {
      const plusBtns = cartSection.querySelectorAll('.cart-page-qty-btn.plus');
      const minusBtns = cartSection.querySelectorAll('.cart-page-qty-btn.minus');

      plusBtns.forEach((btn) => {
        btn.addEventListener('click', () => {
          const line = Number(btn.dataset.line);
          const itemEl = btn.closest('.cart-page-item');
          const qtyEl = itemEl.querySelector('.cart-page-qty-count');
          const currentQty = Number(qtyEl.textContent);
          updateCartPageItem(line, currentQty + 1);
        });
      });

      minusBtns.forEach((btn) => {
        btn.addEventListener('click', () => {
          const line = Number(btn.dataset.line);
          const itemEl = btn.closest('.cart-page-item');
          const qtyEl = itemEl.querySelector('.cart-page-qty-count');
          const currentQty = Number(qtyEl.textContent);
          const newQty = currentQty > 1 ? currentQty - 1 : 0;
          updateCartPageItem(line, newQty);
        });
      });
    };

    // üü¢ Init (cart page only; side cart script will **not** be touched)
    loadCartPageItems();

      // Coupon toggle logic (cart page only)
        const couponToggleText = cartSection.querySelector('.coupon-toggle-text');
        const couponFieldContainer = cartSection.querySelector('.coupon-field-container');

        if (couponToggleText && couponFieldContainer) {
        couponToggleText.addEventListener('click', function () {
            couponToggleText.style.display = 'none';
            couponFieldContainer.style.display = 'block';
        });
        }
  });



</script>

{% schema %}
{
  "name": "t:general.cart",
  "settings": []
}
{% endschema %}
