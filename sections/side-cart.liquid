<div class="side-cart">
  <div class="cart-loader">
    <div class="loader-spinner"></div>
  </div>
  
  <div class="cart-recommendation-wrapper">
    <div class="cr-head">you may also like</div>
    <div class="cart-recommendation" data-lenis-prevent></div>
  </div>
  <div class="sc-wrapper">
    <div class="sc-head">
      <div class="sch-left">
        <p>
          Cart
          <span id="cart_item_count">({{ cart.item_count }} items)</span>
        </p>
        {% if cart.item_count > 0 %}
          <a href="{{ routes.cart_url }}">View Cart</a>
        {% endif %}
      </div>
      <div class="sc-close">
        {% render 'cross' %}
      </div>
    </div>
    <div
      class="sc-shipping-arrival"
      data-user-language="{{ request.locale.name }}"
      data-user-iso="{{ request.locale.iso_code }}"
      data-user-selected-country={{ localization.country.iso_code | json }}>
      {% render 'shipping-icon' %}
      <p>Arrives
        <span id="arrival-date">Sep 2 - Sep 4</span>
      </p>
    </div>
    <div class="sc-in">
      <div class="side-cart-with-items" data-lenis-prevent></div>
    </div>
    <div class="sc-footer">
      {% render 'discount-code-field' %}
      <div class="cart-totals">
        <div class="cart-subtotal">
          <p class="cs-title">Subtotal</p>
          <p class="subtotal-amount cs-res">0.00</p>
        </div>

        <div class="cart-discount" style="display:none;">
          <p class="cs-title">Discount:</p>
          <p class="discount-amount cs-res">-0.00</p>
        </div>

        <div class="cart-shipping">
          <p class="cs-title">Shipping
            <span>(calc. at the checkout)</span>
          </p>
          <p class="shipping-amount cs-res">Calculated at checkout</p>
        </div>

        <div class="cart-total">
          <p class="cs-title">Total <span>incl. VAT</span></p>
          <p class="total-amount cs-res">0.00</p>
        </div>
      </div>
      <form action="/checkout" method="post">
        <button
          name="checkout"
          type="submit"
          class="checkout-btn custom-btn filled"
          style="width: 100%;">
          <span class="checkout-txt">Checkout</span>
          <span class="checkout-total">0.00</span>
        </button>
      </form>
    </div>
  </div>
</div>


<script id="cart_function">
(function () {
  // üõë Do NOT run Side Cart on Cart page
  if (document.body.classList.contains('template-cart')) {
    console.log('üõë Side cart disabled on cart page');
    return;
  }

  let initialized = false;

  document.addEventListener('DOMContentLoaded', initSideCart);

  function initSideCart() {
    if (initialized) return;
    initialized = true;

    /* =======================
       GLOBAL FLAGS
    ======================= */
    window.Shopify = window.Shopify || {};
    window.Shopify.cart_ajax_enabled = true;

    window.__SIDE_CART_REFRESHING__ = false;
    let userActionInProgress = false;

    /* =======================
       HELPERS
    ======================= */

    function formatMoney(cents) {
      return `${window.currencySymbol || ''}${(cents / 100).toFixed(2)} ${window.activeCurrency || ''}`;
    }

    /* =======================
       DOM
    ======================= */
    const sideCart = document.querySelector('.sideCart');
    const cartItemsContainer = document.querySelector('.sc-in');
    const cartItemsWrapper = document.querySelector('.side-cart-with-items');
    const cartFooter = document.querySelector('.sc-footer');
    const loader = document.querySelector('.cart-loader');

    if (!sideCart) {
      console.warn('‚ùå Side cart container not found');
      return;
    }

    function showLoader() { loader?.classList.add('active'); }
    function hideLoader() { loader?.classList.remove('active'); }

    /* =======================
       OPEN / CLOSE
    ======================= */
    document.querySelector('.cart-open')?.addEventListener('click', async () => {
      sideCart.classList.add('active');
      document.body.classList.add('stay');
      document.documentElement.classList.add('stay');
      // Always refresh when opening to show latest cart state
      await loadCartItems(true);
      startCartMonitoring();
    });

    document.querySelector('.sc-close')?.addEventListener('click', () => {
      sideCart.classList.remove('active');
      document.body.classList.remove('stay');
      document.documentElement.classList.remove('stay');
      stopCartMonitoring();
    });

    /* =======================
       RECOMMENDED CART
    ======================= */
    window.recommendedCart = async function (cart) {
      const wrapper = document.querySelector('.cart-recommendation');
      const container = document.querySelector('.cart-recommendation-wrapper');
      if (!wrapper || !container) return;

      try {
        const render = (products) => {
          if (!products?.length) {
            container.style.display = 'none';
            return;
          }

          container.style.display = 'flex';

          wrapper.innerHTML = products.map(p => {
            const img =
              typeof p.featured_image === 'string'
                ? p.featured_image
                : p.featured_image?.src || p.images?.[0]?.src || '';

            const variantId = p.variants?.[0]?.id;
            if (!variantId) return '';

            return `
              <div class="recommended-item">
                <div class="ri-img">
                  <img src="${img}" alt="${p.title}" class="product-card__image">
                </div>
                <div class="ri-txt">
                  <p class="rit-title">${p.title}</p>
                </div>
                <div class="ri-form">
                  <form action="/cart/add" method="post" data-external-add>
                    <input type="hidden" name="id" value="${variantId}">
                    <input type="hidden" name="quantity" value="1">
                    <div class="fc_add_to_cart">
                      <span class="remove_product">-</span>
                      <button type="submit" class="add-to-cart">Add to Cart</button>
                      <span class="add_product">+</span>
                    </div>
                  </form>
                </div>
              </div>
            `;
          }).join('');

          attachAddToCartListeners(wrapper);
        };

        if (cart.items.length) {
          const res = await fetch(`/recommendations/products.json?product_id=${cart.items[0].product_id}&limit=8`);
          const data = await res.json();
          render(data.products);
        } else {
          const res = await fetch('/collections/fruit/products.json?limit=8');
          const data = await res.json();
          render(data.products || data);
        }
      } catch (e) {
        console.error('Recommended cart error', e);
      }
    };

    let lastCartSnapshot = null;
    let cartMonitorInterval = null;
    let monitoringActive = false;

    /* =======================
       GLOBAL CART UPDATE LISTENER
    ======================= */
    // Listen for cart:updated events from anywhere in the app
    document.addEventListener('cart:updated', async (e) => {
      console.log('üéÅ [SideCart] cart:updated event received, refreshing...');
      
      // Refresh immediately if cart is open, or when it opens next
      if (sideCart.classList.contains('active')) {
        await loadCartItems(true);
      } else {
        // Update snapshot so when cart opens, it shows latest data
        try {
          const res = await fetch('/cart.js');
          const cart = await res.json();
          lastCartSnapshot = JSON.stringify(
            cart.items.map(i => ({
              key: i.key,
              qty: i.quantity,
              price: i.final_line_price
            }))
          );
        } catch (e) {
          console.error('[SideCart] Error updating snapshot', e);
        }
      }
    });

    /* =======================
       INTERCEPT CART ADD REQUESTS
    ======================= */
    // Intercept all /cart/add.js fetch calls to refresh side cart
    const originalFetch = window.fetch;
    window.fetch = async function(...args) {
      const url = args[0];
      if (typeof url === 'string' && url.includes('/cart/add.js') && args[1]?.method === 'POST') {
        const response = await originalFetch.apply(this, args);
        
        // After successful add, refresh side cart
        if (response.ok) {
          console.log('üîÑ [SideCart] External add detected, refreshing...');
          // Small delay to let gift app process
          setTimeout(async () => {
            if (sideCart.classList.contains('active')) {
              await loadCartItems(true);
            } else {
              // Update snapshot for when cart opens
              try {
                const res = await fetch('/cart.js');
                const cart = await res.json();
                lastCartSnapshot = JSON.stringify(
                  cart.items.map(i => ({
                    key: i.key,
                    qty: i.quantity,
                    price: i.final_line_price
                  }))
                );
              } catch (e) {
                console.error('[SideCart] Error updating snapshot', e);
              }
            }
          }, 500);
        }
        
        return response;
      }
      return originalFetch.apply(this, args);
    };

    function startCartMonitoring() {
      if (cartMonitorInterval || monitoringActive) return;
      
      monitoringActive = true;
      console.log('üëÄ [SideCart] Starting cart monitoring');
      
      cartMonitorInterval = setInterval(async () => {
        if (!sideCart.classList.contains('active')) {
          stopCartMonitoring();
          return;
        }

        if (userActionInProgress || window.__SIDE_CART_REFRESHING__) {
          return;
        }

        try {
          const res = await fetch('/cart.js');
          
          if (res.status === 429) {
            console.warn('‚ö†Ô∏è [SideCart] Rate limit hit');
            stopCartMonitoring();
            setTimeout(() => {
              if (sideCart.classList.contains('active')) {
                startCartMonitoring();
              }
            }, 5000);
            return;
          }

          const cart = await res.json();

          const currentSnapshot = JSON.stringify(
            cart.items.map(i => ({
              key: i.key,
              qty: i.quantity,
              price: i.final_line_price
            }))
          );

          if (lastCartSnapshot && currentSnapshot !== lastCartSnapshot) {
            console.log('üéÅ [SideCart] Cart changed externally, refreshing...');
            lastCartSnapshot = currentSnapshot;
            loadCartItems(true);
          }
        } catch (e) {
          console.error('[SideCart] Monitoring error', e);
        }
      }, 3000);
    }

    function stopCartMonitoring() {
      if (cartMonitorInterval) {
        console.log('üõë [SideCart] Stopping cart monitoring');
        clearInterval(cartMonitorInterval);
        cartMonitorInterval = null;
        monitoringActive = false;
      }
    }

    /* =======================
       LOAD CART
    ======================= */
    window.loadCartItems = async function (force = false) {
      if (window.__SIDE_CART_REFRESHING__ && !force) {
        console.log('[SideCart] Already refreshing, skipping');
        return;
      }
      
      window.__SIDE_CART_REFRESHING__ = true;
      showLoader();

      try {
        const res = await fetch('/cart.js');
        
        if (res.status === 429) {
          console.error('‚ö†Ô∏è [SideCart] Rate limit hit while loading cart');
          hideLoader();
          window.__SIDE_CART_REFRESHING__ = false;
          return;
        }

        const cart = await res.json();
        console.log('üì¶ [SideCart] Cart loaded:', cart.item_count, 'items');

        const snapshot = JSON.stringify(
          cart.items.map(i => ({
            key: i.key,
            qty: i.quantity,
            price: i.final_line_price
          }))
        );

        lastCartSnapshot = snapshot;

        // Update cart count
        const cartCount = document.getElementById('cart_item_count');
        if (cartCount) {
          cartCount.textContent = `(${cart.item_count} items)`;
        }

        // Sync discount fields
        document.querySelectorAll('discount-field')
          .forEach(df => df.updateFromCart?.(cart));

        // Recommended products
        await recommendedCart(cart);

        // EMPTY CART
        if (!cart.items.length) {
          cartItemsWrapper.style.display = 'none';
          cartFooter.style.display = 'none';
          // Clear any existing items first
          cartItemsWrapper.innerHTML = '';
          // Show empty message
          cartItemsContainer.innerHTML = `
            <div class="side-cart-empty">
              <div class="jf-icon">{% render 'jf' %}</div>
              <div class="sce-txt">
                <h3>uh-oh!</h3>
                <p>You have an empty basket.</p>
              </div>
            </div>`;
          return;
        }

        // CRITICAL: Restore cartItemsWrapper if it was removed by empty state
        let activeWrapper = cartItemsWrapper;
        if (!cartItemsWrapper || !cartItemsContainer.contains(cartItemsWrapper)) {
          cartItemsContainer.innerHTML = '<div class="side-cart-with-items" data-lenis-prevent></div>';
          // Re-query after restoring
          activeWrapper = document.querySelector('.side-cart-with-items');
        }

        if (!activeWrapper) {
          console.error('‚ùå [SideCart] Could not find or restore cartItemsWrapper');
          return;
        }

        activeWrapper.style.display = 'block';
        cartFooter.style.display = 'block';

        // ITEMS
        activeWrapper.innerHTML = cart.items.map((item, index) => {
          const isFreeGift =
            item.final_line_price === 0 &&
            item.original_line_price > 0;

          return `
            <div class="cart-item" data-key="${item.key}">
              <div class="cart-item-left">
                <div class="cart-item-image">
                  <a href="${item.url}">
                    <img src="${item.image}" alt="${item.product_title}" class="cart-image" />
                  </a>
                </div>
                <div class="cart-item-info">
                  <a href="${item.url}">
                    <p class="cart-item-title">${item.product_title}</p>
                  </a>
                  <p class="cart-price">
                    ${isFreeGift ? 'FREE' : formatMoney(item.final_line_price)}
                  </p>
                </div>
              </div>

              <div class="cart-qty">
                <button class="qty-btn minus" data-line="${index + 1}" data-key="${item.key}" data-qty="${item.quantity}">
                  ${item.quantity > 1 ? `{% render 'minus-icon' %}` : `{% render 'bin-icon' %}`}
                </button>
                <span class="qty-count">${item.quantity}</span>
                <button class="qty-btn plus" data-line="${index + 1}" data-key="${item.key}" data-qty="${item.quantity}">
                  {% render 'plus-icon' %}
                </button>
              </div>
            </div>
          `;
        }).join('');

        // TOTALS
        const originalSubtotal = cart.items.reduce(
          (sum, item) => sum + item.original_line_price,
          0
        );

        document.querySelectorAll('.subtotal-amount')
          .forEach(el => el.textContent = formatMoney(originalSubtotal));

        document.querySelectorAll('.total-amount, .checkout-total')
          .forEach(el => el.textContent = formatMoney(cart.total_price));

        const discountRow = document.querySelector('.cart-discount');
        const discountAmountEl = document.querySelector('.discount-amount');
        const discount = originalSubtotal - cart.total_price;

        if (discount > 0) {
          discountRow.style.display = 'flex';
          discountAmountEl.textContent = `- ${formatMoney(discount)}`;
        } else {
          discountRow.style.display = 'none';
        }

        attachQtyHandlers();

      } catch (e) {
        console.error('‚ùå [SideCart] Error loading cart', e);
      } finally {
        hideLoader();
        window.__SIDE_CART_REFRESHING__ = false;
      }
    };

    /* =======================
       QTY
    ======================= */
    function attachQtyHandlers() {
      document.querySelectorAll('.plus').forEach(btn => {
        btn.onclick = () => updateCartItem(btn.dataset.key, Number(btn.dataset.qty) + 1);
      });
      document.querySelectorAll('.minus').forEach(btn => {
        btn.onclick = () => updateCartItem(btn.dataset.key, Math.max(0, Number(btn.dataset.qty) - 1));
      });
    }

    async function updateCartItem(key, qty) {
      if (userActionInProgress) {
        console.log('‚è≥ [SideCart] Update already in progress');
        return;
      }

      console.log(`üîÑ [SideCart] Updating item ${key} to qty ${qty}`);
      userActionInProgress = true;
      showLoader();

      try {
        const response = await fetch('/cart/change.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: key, quantity: qty })
        });

        if (response.status === 429) {
          alert('Too many requests. Please wait a moment.');
          return;
        }

        console.log('‚úÖ [SideCart] Update request sent, waiting for gift app...');

        // ‚úÖ Wait for gift app to process
        await new Promise(resolve => setTimeout(resolve, 1500));

        await loadCartItems(true);

      } catch (e) {
        console.error('‚ùå [SideCart] Update error', e);
        await loadCartItems(true);
      } finally {
        hideLoader();
        userActionInProgress = false;
      }
    }


    /* =======================
       ADD TO CART
    ======================= */
    function attachAddToCartListeners(scope = document) {
      const forms = scope.querySelectorAll('form[action$="/cart/add"]');
      
      forms.forEach((form, index) => {
        if (form.dataset.bound) {
          return;
        }
        form.dataset.bound = 'true';

        // Listen to both form submit AND button click (in case button click bypasses form submit)
        const submitHandler = async e => {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          
          if (userActionInProgress) {
            console.log('‚è≥ [SideCart] Add already in progress');
            return;
          }

          console.log('‚ûï [SideCart] Adding to cart...');
          userActionInProgress = true;
          showLoader();

          try {
            const response = await fetch('/cart/add.js', { 
              method: 'POST', 
              body: new FormData(form) 
            });

            if (response.status === 429) {
              alert('Too many requests. Please wait a moment.');
              hideLoader();
              userActionInProgress = false;
              return;
            }

            if (!response.ok) {
              throw new Error('Failed to add to cart');
            }

            console.log('‚úÖ [SideCart] Add successful, opening cart...');
            
            // ‚úÖ CRITICAL FIX: Start monitoring BEFORE opening cart
            if (!monitoringActive) {
              startCartMonitoring();
            }
            
            // Open cart
            sideCart.classList.add('active');
            document.body.classList.add('stay');
            document.documentElement.classList.add('stay');

            // ‚úÖ Refresh cart immediately - retry if needed for gift app processing
            console.log('üîÑ [SideCart] Loading cart items immediately...');
            await loadCartItems(true);
            
            // Retry after short delay to catch gift app updates
            setTimeout(async () => {
              if (sideCart.classList.contains('active')) {
                console.log('üîÑ [SideCart] Retry refresh for gift app updates...');
                await loadCartItems(true);
              }
            }, 500);

          } catch (e) {
            console.error('‚ùå [SideCart] Add to cart error', e);
            await loadCartItems(true);
          } finally {
            hideLoader();
            userActionInProgress = false;
          }
        };

        form.addEventListener('submit', submitHandler, { capture: true });
        
        // Also listen to button clicks directly (in case they bypass form submit)
        const button = form.querySelector('button[type="submit"], .add-to-cart');
        if (button) {
          button.addEventListener('click', submitHandler, { capture: true });
        }
      });
    }

    attachAddToCartListeners();
    loadCartItems();
  }
})();
</script>




{% schema %}
  {
    "name": "Side Cart",
    "class": "sideCart",
    "tag": "section",
    "settings": []
  }
{% endschema %}