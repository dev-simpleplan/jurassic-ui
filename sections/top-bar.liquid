<div class="top-bar">
    <div class="container">
        <div class="top-bar-in">
            <div class="tb-rating">
                <div class="tbr-icon">
                    <img class="icon" src="{{ section.settings.rating_image | img_url: 'master' }}" alt="{{ section.settings.rating_image }}">
                </div>
                <div class="tbr-text">{{ section.settings.rating_text }}</div>
            </div>
            <div class="tb-text">
                <p>{{ section.settings.tbtext_text }}</p>
            </div>
            {% comment %} <div class="tb-lang-wrap">
                {% if localization.available_countries.size > 1 %}
                <div class="dropdown country-dropdown">
                    <button class="dropdown-trigger" type="button">
                    <span class="flag">
                        <img
                        src="https://flagcdn.com/w20/{{ localization.country.iso_code | downcase }}.png"
                        alt="{{ localization.country.name }}"
                        width="20"
                        height="14"
                        >
                    </span>
                    <span class="label">
                        {{ localization.country.name }}
                        ({{ localization.country.currency.iso_code }})
                    </span>
                    </button>

                    <ul class="dropdown-menu">
                    {% for country in localization.available_countries %}
                        <li>
                        <a href="{{ routes.root_url }}?country={{ country.iso_code }}">
                            <img
                            src="https://flagcdn.com/w20/{{ country.iso_code | downcase }}.png"
                            alt="{{ country.name }}"
                            width="20"
                            height="14"
                            >
                            <span>
                            {{ country.name }}
                            ({{ country.currency.iso_code }})
                            </span>
                        </a>
                        </li>
                    {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if localization.available_languages.size > 1 %}
                {% assign lang_flags = 'en:gb,fr:fr,de:de' | split: ',' %}

                <div class="dropdown language-dropdown">
                    <button class="dropdown-trigger" type="button">
                    {% for map in lang_flags %}
                        {% assign pair = map | split: ':' %}
                        {% if pair[0] == localization.language.iso_code %}
                        <img
                            src="https://flagcdn.com/w20/{{ pair[1] }}.png"
                            alt="{{ localization.language.endonym_name }}"
                            width="20"
                            height="14"
                        >
                        {% endif %}
                    {% endfor %}
                    <span class="label">
                        {{ localization.language.endonym_name }}
                    </span>
                    </button>

                    <ul class="dropdown-menu">
                    {% for language in localization.available_languages %}
                        <li>
                        <a href="{{ language.root_url }}">
                            {% for map in lang_flags %}
                            {% assign pair = map | split: ':' %}
                            {% if pair[0] == language.iso_code %}
                                <img
                                src="https://flagcdn.com/w20/{{ pair[1] }}.png"
                                alt="{{ language.endonym_name }}"
                                width="20"
                                height="14"
                                >
                            {% endif %}
                            {% endfor %}
                            <span>{{ language.endonym_name }}</span>
                        </a>
                        </li>
                    {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div> {% endcomment %}
            <div class="tb-lang-wrap">
                <button class="locale-trigger" type="button" data-locale-open>
                    <img
                    src="https://flagcdn.com/w20/{{ localization.country.iso_code | downcase }}.png"
                    alt="{{ localization.country.name }}"
                    width="20"
                    height="14"
                    >
                    <span>
                    {{ localization.country.name }} |
                    {{ localization.language.iso_code | upcase }}
                    </span>
                </button>
            </div>

        </div>
    </div>
</div>

<div
  class="locale-modal"
  data-locale-modal
  data-current-country="{{ localization.country.iso_code }}"
  data-current-language="{{ localization.language.iso_code }}"
  data-lenis-prevent
>
  <div class="locale-backdrop" data-locale-close></div>

  <div class="locale-panel" data-lenis-prevent>
    <button class="locale-close" type="button" data-locale-close>Ã—</button>

    <!-- COUNTRIES -->
    <div class="countries-select">
        {% if localization.available_countries.size > 1 %}
        <h3>Select country</h3>
        <ul class="locale-list">
            {% for country in localization.available_countries %}
            <li>
                <a href="#" data-country="{{ country.iso_code }}">
                <img
                    src="https://flagcdn.com/w20/{{ country.iso_code | downcase }}.png"
                    alt="{{ country.name }}"
                    width="20"
                    height="14"
                >
                <span>
                    {{ country.name }}
                    ({{ country.currency.iso_code }})
                </span>
                </a>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>

    <!-- LANGUAGES -->
    <div class="language-select">
        {% if localization.available_languages.size > 1 %}
        <h3>Select language</h3>
        <ul class="locale-list">
            {% for language in localization.available_languages %}
            <li>
                <a
                    href="#"
                    data-language="{{ language.iso_code }}"
                    data-language-url="{{ language.root_url }}"
                >
                <span class="lang-code">
                    {{ language.iso_code | upcase }}
                </span>
                <span>{{ language.endonym_name }}</span>
                </a>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    <div class="language-btn">
        <button class="locale-apply custom-btn filled rounded" type="button" data-locale-apply>Apply</button>
    </div>
  </div>
</div>


{% comment %} <script>
document.addEventListener('click', function (e) {
  document.querySelectorAll('.dropdown').forEach(dropdown => {
    const button = dropdown.querySelector('.dropdown-trigger');

    if (button.contains(e.target)) {
      dropdown.classList.toggle('open');
    } else {
      dropdown.classList.remove('open');
    }
  });
});
</script> {% endcomment %}

<script>
document.addEventListener('click', function (e) {
  const modal = document.querySelector('[data-locale-modal]');
  if (!modal) return;

  /* ----------------------------
     OPEN MODAL
  ----------------------------- */
  if (e.target.closest('[data-locale-open]')) {
    modal.classList.add('is-open');

    const currentCountry = modal.dataset.currentCountry;
    const currentLanguage = modal.dataset.currentLanguage;

    // Store defaults
    modal.dataset.selectedCountry = currentCountry;
    modal.dataset.selectedLanguage = currentLanguage;

    // Highlight current country
    modal.querySelectorAll('[data-country]').forEach(el => {
      el.classList.toggle(
        'is-selected',
        el.dataset.country === currentCountry
      );
    });

    // Highlight current language
    modal.querySelectorAll('[data-language]').forEach(el => {
      el.classList.toggle(
        'is-selected',
        el.dataset.language === currentLanguage
      );
    });

    return;
  }

  /* ----------------------------
     CLOSE MODAL
  ----------------------------- */
  if (e.target.closest('[data-locale-close]')) {
    modal.classList.remove('is-open');
    return;
  }

  /* ----------------------------
     SELECT COUNTRY
  ----------------------------- */
  const countryEl = e.target.closest('[data-country]');
  if (countryEl) {
    e.preventDefault();
    modal.dataset.selectedCountry = countryEl.dataset.country;

    modal.querySelectorAll('[data-country]').forEach(el =>
      el.classList.remove('is-selected')
    );
    countryEl.classList.add('is-selected');
    return;
  }

  /* ----------------------------
     SELECT LANGUAGE
  ----------------------------- */
  const languageEl = e.target.closest('[data-language]');
  if (languageEl) {
    e.preventDefault();
    modal.dataset.selectedLanguage = languageEl.dataset.language;
    modal.dataset.selectedLanguageUrl = languageEl.dataset.languageUrl;

    modal.querySelectorAll('[data-language]').forEach(el =>
      el.classList.remove('is-selected')
    );
    languageEl.classList.add('is-selected');
    return;
  }

  /* ----------------------------
     APPLY
  ----------------------------- */
  if (e.target.closest('[data-locale-apply]')) {
    const country = modal.dataset.selectedCountry;
    const languageCode = modal.dataset.selectedLanguage;
    
    // 1. Get current path (e.g., /products/mango)
    let currentPath = window.location.pathname;
    
    // 2. Remove existing language prefix from path if necessary
    // Shopify handles language roots like /en, /fr, etc.
    const availableLanguages = [];
    {% for language in localization.available_languages %}
      availableLanguages.push('{{ language.iso_code }}');
    {% endfor %}
    
    const pathParts = currentPath.split('/');
    if (pathParts[1] && availableLanguages.includes(pathParts[1])) {
      pathParts.splice(1, 1); // Remove the old language code
      currentPath = pathParts.join('/') || '/';
    }

    // 3. Build the new URL
    // If language is not the default, add it to the path
    let newPath = (languageCode === '{{ shop.published_locales.first.iso_code }}') 
                  ? currentPath 
                  : '/' + languageCode + currentPath;

    // Clean up double slashes
    newPath = newPath.replace(/\/+/g, '/');

    const finalUrl = new URL(newPath, window.location.origin);
    
    // 4. Set the country parameter
    if (country) {
      finalUrl.searchParams.set('country', country);
    }
    
    // Keep existing search params (like variants) if you want
    const currentParams = new URLSearchParams(window.location.search);
    currentParams.forEach((value, key) => {
      if (key !== 'country') { // Don't overwrite our new country
        finalUrl.searchParams.set(key, value);
      }
    });

    window.location.href = finalUrl.toString();
  }
});
</script>









{% schema %}
  {
    "name": "top-bar",
    "tag": "section",
    "settings": [
        {
            "type": "image_picker",
            "id": "rating_image",
            "label": "Rating Image"
        },
        {
            "type": "text",
            "id": "rating_text",
            "label": "Rating Text"
        },
        {
            "type": "text",
            "id": "tbtext_text",
            "label": "Announcement Text"
        }

    ],
    "presets": [
        {
            "name": "top-bar",
            "settings": {
            }
        }
    ]
  }
{% endschema %}