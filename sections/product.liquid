<link
  rel="stylesheet"
  type="text/css"
  href="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" />
<script
  type="text/javascript"
  src="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"
  defer></script>


<div class="pro-breadcrumbs">
  <div class="container">
      <div class="bcrum-in">
        <ul>
          <li><a href="{{ routes.root_url }}">Home</a></li>
          <li><a href="/collections/all">Shop All</a></li>
          {% assign current_collection = collection | default: product.collections.first %}
          {% if current_collection %}
            <li>
              <a href="{{ current_collection.url }}">
                {{ current_collection.title }}
              </a>
            </li>
          {% endif %}
          <li><span>{{ product.title }}</span></li>
        </ul>
      </div>
  </div>
</div>

{% assign default_variant = nil %}

{% for variant in product.variants %}
  {% if variant.metafields.custom.is_prior == true and variant.available %}
    {% assign default_variant = variant %}
    {% break %}
  {% endif %}
{% endfor %}

{% if default_variant == nil %}
  {% for variant in product.variants %}
    {% if variant.available %}
      {% assign default_variant = variant %}
      {% break %}
    {% endif %}
  {% endfor %}
{% endif %}

{% if default_variant == nil %}
  {% assign default_variant = product.variants.first %}
{% endif %}

{% assign selected_variant = default_variant %}

<div class="product-info">
  <div class="container">
    <div class="pro-grid">
       <div class="pro-img-wrap">
          <div class="pro-img">
            <div class="pro-right-side">
              <div class="prs-data">
                {% if product.tags.size > 0 %}
                    <div class="fc_category_tags">
                      {% for tag in product.tags %}
                        {% unless tag == 'Best Seller' %}
                          <span>{{ tag }}</span>
                        {% endunless %}
                      {% endfor %}
                    </div>
                  {% endif %}

                  {% if product.tags contains 'Best Seller' %}
                    <div class="fc_bestsell_tags">
                      <span>Bestseller</span>
                    </div>
                  {% endif %}
              </div>
              <div class="prod-main-image">
                {% if product.media.size > 0 %}
                  {% for media in product.media %}
                    <div class="item">
                      <div class="prod-main">
                        {% render 'product-media', media: media %}
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  {% comment %} This renders ONLY if there are no images/videos {% endcomment %}
                  <div class="item">
                    <div class="prod-main">
                      <img
                        src="https://cdn.shopify.com/s/files/1/0752/8015/4881/files/jf-placeholder.png?v=1769522647"
                        alt="{{ product.title }}"
                        class="image-custom"
                        loading="lazy">
                    </div>
                  </div>
                {% endif %}
              </div>
              <div class="btn-wrap">
                <button class="custom-prev">
                  {%- render 'arrow-prev' -%}
                </button>
                <button class="custom-next">
                  {%- render 'arrow-next' -%}
                </button>
              </div>
            </div>
            <div class="prod-thumb-image">
              {% if product.media.size > 0 %}
                {% for media in product.media %}
                  <div class="item">
                    <div class="prod-thumb">
                      {% render 'product-media', media: media %}
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                {% comment %} Show a small thumbnail placeholder if no media exists {% endcomment %}
                <div class="item">
                  <div class="prod-thumb">
                    <img
                      src="https://cdn.shopify.com/s/files/1/0752/8015/4881/files/jf-placeholder.png?v=1769522647"
                      alt="Placeholder"
                      class="image-custom thumb-placeholder"
                      loading="lazy">
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
          <div class="pro-test">
            {% for block in section.blocks %}
              {% if block.settings.show_testimonial 
                and product.metafields.custom.title_testimonial != blank %}
                <div class="tr-testimonial">
                  {% render 'testimonial-icon' %}
                  {{ product.metafields.custom.title_testimonial | metafield_tag }}
                </div>
              {% endif %}
            {% endfor %}
          </div>
       </div>
      <div class="pro-desp">
        {% form 'product'
          , product
          , id: 'product-form'
          , novalidate: 'novalidate' %}
          <input
            type="hidden"
            name="id"
            value="{{ selected_variant.id }}">

          {% for block in section.blocks %}
            {% case block.type %}
              {% when 'title' %}
                <div class="title">
                  <div class="title-review">
                    {% comment %} {% if block.settings.show_testimonial 
                      and product.metafields.custom.title_testimonial != blank %}
                      <div class="tr-testimonial">
                        {% render 'testimonial-icon' %}
                        {{ product.metafields.custom.title_testimonial | metafield_tag }}
                      </div>
                    {% endif %} {% endcomment %}

                    <!-- OKENDO APP BLOCK BESIDE TESTIMONIAL -->
                    <div class="tr-okendo">
                      <p data-oke-star-rating data-oke-reviews-product-id="shopify-{{ product.id }}"></p>
                    </div>

                    {% assign certificate = product.metafields.custom.certificate %}
                    <div class="tr-review-certi">
                      <div class="ts-certificate">
                        {% if certificate != '' %}
                          {% for item in certificate.value %}
                            <div class="tsc-img">
                              <img src="{{ item.badge_image |  img_url: 'master' }}" alt="{{ item.display_name }}" class="img">
                            </div>
                          {% endfor %}
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  <h1>{{ product.title }}</h1>
                    <div class="price" id="price-{{ section.id }}">
                        <div class="price-detailsss"> 
                            <span class="sell-price"> 
                              {{ selected_variant.price | money }}
                            </span>
                            {% if selected_variant.price < selected_variant.compare_at_price %}
                              <strike class="real-price">{{ selected_variant.compare_at_price | money }}</strike>
                            {% endif %}
                        </div>
                        <span class="price-txt">
                          Taxes, Excl. shipping
                        </span>
                    </div>
                    {% if selected_variant.compare_at_price > selected_variant.price %}
                      <div class="vvv-discount">
                        {% assign discount = selected_variant.compare_at_price | minus: selected_variant.price %}
                        {% assign discount_percentage = discount | times: 100 | divided_by: selected_variant.compare_at_price | round %}
                        {{ discount_percentage }}% OFF
                      </div>
                    {% endif %}
                </div>

              {% when 'product_usp' %}
                <div class="product-usp">
                  {% for item in product.metafields.custom.product_usp.value %}
                    <div class="pu-item">
                      <div class="pui-icon">
                        <img src="{{ item.usp_icon |  img_url: 'master' }}" alt="{{ item.usp_text }}">
                      </div>
                      <div class="pui-txt">
                        <p>{{ item.usp_text }}</p>
                      </div>
                    </div>
                  {% endfor %}
                </div>

              {% when 'product_info' %}
                <div class="product-info-block">
                  {% comment %} For Origin {% endcomment %}
                  <div class="pi-item">
                    {% render 'green-tick' %}
                    <div class="pii-info">
                      <p>
                        <strong>Origin:</strong>
                        {{ product.metafields.custom.country_of_origin.value.country_name }}
                      </p>
                    </div>
                  </div>
                  {% comment %} Seasonality {% endcomment %}
                  <div class="pi-item">
                    {% render 'green-tick' %}
                    <div class="pii-info">
                      <p>
                        <strong>Seasonality:</strong>
                        {{ product.metafields.custom.country_season.value.season.value.seasonality }}
                      </p>
                    </div>
                  </div>

                  {% comment %} Additional Information {% endcomment %}
                  {% for item in product.metafields.custom.additional_information.value %}
                    <div class="pi-item">
                      {% render 'green-tick' %}
                      <div class="pii-info">
                        <p>
                          <strong>{{ item.inforamation_title }}</strong>
                          {{ item.information_paragraph }}
                        </p>
                      </div>
                    </div>
                  {% endfor %}
                </div>

              {% when 'store_usp' %}
                <div class="store-usp">
                  {% comment %} For Shipping USP {% endcomment %}
                  <div class="su-item">
                    <div class="sui-icon">
                      <img src="{{ block.settings.shipping_usp_icon |  img_url: 'master' }}" alt="{{ block.settings.shipping_usp_text }}">
                    </div>
                    <div class="sui-txt">
                      <a href="{{ block.settings.shipping_usp_page.url }}">{{ block.settings.shipping_usp_text }}</a>
                    </div>
                  </div>

                  {% comment %} For Freshness USP {% endcomment %}
                  {% if product.metafields.custom.fresh_product != true %}

                  {% else %}
                    <div class="su-item">
                      <div class="sui-icon">
                        <img src="{{ block.settings.freshness_icon |  img_url: 'master' }}" alt="{{ block.settings.freshness_text }}">
                      </div>
                      <div class="sui-txt">
                        <p id="delivered-fresh">{{ block.settings.freshness_text }}</p>
                      </div>
                    </div>
                  {% endif %}

                  {% comment %} For Payment USP {% endcomment %}
                  <div class="su-item">
                    <div class="sui-icon">
                      <img src="{{ block.settings.payment_usp_icon |  img_url: 'master' }}" alt="{{ block.settings.payment_usp_text }}">
                    </div>
                    <div class="sui-txt">
                      <p id="delivered-fresh">{{ block.settings.payment_usp_text }}</p>
                    </div>
                  </div>
                </div>

              {% when 'variant_selector' %}
                <div class="variant">
                  <div class="variant-wrapper">
                    <div class="select_variant">
                      {% unless product.has_only_default_variant %}
                        <variant-selector data-url="{{ product.url }}" data-section="{{ section.id }}">
                          <div class="sv-perKg">
                            <p>Select variant</p>
                            <div class="perKg">
                              {% if selected_variant.unit_price_measurement %}
                                {{ selected_variant.unit_price | money }} / {{ selected_variant.unit_price_measurement.reference_unit }}
                              {% comment %} {{ selected_variant.unit_price_measurement.reference_value }} {% endcomment %}
                              {% else %}
                                {{ selected_variant.price | money }} / unit
                              {% endif %}
                            </div>
                          </div>
                          {% for option in product.options_with_values %}
                            <div class="variant-option" data-option="{{ option.name }}">
                              <ul class="variant-values" data-index="{{ forloop.index0 }}">
                                {% for value in option.values %}
                                  {% assign matched_variant = nil %}

                                  {% for variant in product.variants %}
                                    {% case option.position %}
                                      {% when 1 %}
                                        {% if variant.option1 == value %}
                                          {% assign matched_variant = variant %}
                                          {% break %}
                                        {% endif %}
                                      {% when 2 %}
                                        {% if variant.option2 == value %}
                                          {% assign matched_variant = variant %}
                                          {% break %}
                                        {% endif %}
                                      {% when 3 %}
                                        {% if variant.option3 == value %}
                                          {% assign matched_variant = variant %}
                                          {% break %}
                                        {% endif %}
                                    {% endcase %}
                                  {% endfor %}

                                  <li
                                    class="variant-value {% if option.selected_value == value %}active{% endif %}"
                                    data-value="{{ value | escape }}"
                                    {% if matched_variant.metafields.custom.bestseller == true %}
                                    data-best="bestseller"
                                    {% endif %}>
                                    {% if matched_variant.metafields.custom.bestseller == true %}
                                      <div class="vv-bestseller">best seller</div>
                                    {% endif %}
                                    <div class="vv-value">
                                      <div class="vvv-value">
                                        {{ value }}
                                      </div>
                                      {% if matched_variant.compare_at_price > matched_variant.price %}
                                        <div class="vvv-discount">
                                          {% assign discount = matched_variant.compare_at_price | minus: matched_variant.price %}
                                          {% assign discount_percentage = discount | times: 100 | divided_by: matched_variant.compare_at_price | round %}
                                          {{ discount_percentage }}% OFF
                                        </div>
                                      {% endif %}
                                    </div>
                                    <div class="vv-peices">
                                      {% comment %} <pre>{{ matched_variant.metafields.custom.pieces.value | json }}</pre> {% endcomment %}
                                      {% if matched_variant.metafields.custom.pieces %}
                                        {{ matched_variant.metafields.custom.pieces }}
                                      {% endif %}
                                      {{ matched_variant.price | money }}
                                    </div>
                                  </li>
                                {% endfor %}
                              </ul>
                            </div>
                          {% endfor %}

                          <script type="application/json">
                            {{ product.variants | json }}
                          </script>
                        </variant-selector>
                      {% endunless %}
                    </div>
                    <div class="priceCheckout">
                      {% comment %} <div class="price" id="price-{{ section.id }}">
                        {% if selected_variant.price < selected_variant.compare_at_price %}
                          <strike class="real-price">{{ selected_variant.compare_at_price | money }}</strike>
                        {% endif %}
                        <span class="sell-price">
                          {{ selected_variant.price | money }}
                        </span>
                        <span class="price-txt">
                          Taxes, Excl. shipping
                        </span>
                      </div> {% endcomment %}
                      <div class="submit submit--with-qty">
                        <div class="qty-selector">
                          <button type="button" class="qty-btn minus" data-action="decrease">−</button>
                          <input
                            type="number"
                            name="quantity"
                            id="Quantity"
                            value="1"
                            min="1"
                          >
                          <button type="button" class="qty-btn plus" data-action="increase">+</button>
                        </div>

                        <button
                          type="button"
                          class="custom-btn filled"
                          id="add-to-cart"
                        >
                          <span class="btn-text">
                            <span class="btn-label">Add to Cart</span>
                            <span class="btn-price">—</span>
                          </span>

                          <span class="btn-spinner" aria-hidden="true"></span>
                          <span class="btn-check" aria-hidden="true">✓</span>
                        </button>
                      </div>

                    </div>
                    {% comment %} <div class="payment-options">
                      <p>Guaranteed safe checkout with payment options</p>
                      <div class="po-icon-wrap">
                        {%- unless shop.enabled_payment_types == empty -%}
                          {%- for type in shop.enabled_payment_types -%}
                            {{ type | payment_type_svg_tag: class: 'icon icon--full-color' }}
                          {%- endfor -%}
                        {%- endunless -%}
                      </div>
                    </div> {% endcomment %}
                  </div>
                </div>

              {% when 'offer' %}
                {%- comment -%} Calculate indices for peeking at previous/next blocks {%- endcomment -%}
                {% assign prev_index = forloop.index0 | minus: 1 %}
                {% assign next_index = forloop.index0 | plus: 1 %}
                
                {%- comment -%} 
                  Only open the container if this is the FIRST offer in a consecutive row.
                {%- endcomment -%}
                {% if forloop.first or section.blocks[prev_index].type != 'offer' %}
                  <div class="product-offers">
                    <div class="offers-head">Offers</div>
                    <div class="offers-list">
                {% endif %}

                    <div class="offer-card" {{ block.shopify_attributes }}>
                      <div class="offer-left">
                        <span class="offer-icon">{% render 'icon-offer' %}</span>
                        <div>
                          <p class="offer-code">{{ block.settings.code }}</p>
                          <p class="offer-text">{{ block.settings.text }}</p>
                        </div>
                      </div>
                      <button type="button" class="offer-copy-btn" data-code="{{ block.settings.code }}">
                        {{ block.settings.code }}{% render 'icon-copy' %}
                      </button>
                    </div>

                {%- comment -%} 
                  Only close the container if the NEXT block is NOT an offer, or it's the last block.
                {%- endcomment -%}
                {% if forloop.last or section.blocks[next_index].type != 'offer' %}
                    </div>
                  </div>
                {% endif %}

              {% when '@app' %}
                <div class="app-block">{% render block %}</div>

            {% endcase %}
          {% endfor %}
        {% endform %}
      </div>
    </div>
  </div>
  <script type="application/ld+json">
    {{ product | structured_data }}
  </script>
</div>

<div class="product-accordion">
  <div class="container">
    <div class="pa-wrapper">
      {% comment %} How to Store {% endcomment %}
      <div class="pa-item">
        <div class="pa-ques-wrap">
          <div class="pa-ques">
            {{ section.settings.acc_1 }}
          </div>
          <div class="pa-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none">
              <path
                d="M12 8V16"
                stroke="#202322"
                stroke-width="2"
                class="plus-horizontal"
                stroke-linejoin="round" />
              <path
                d="M8 12H16"
                stroke="#202322"
                stroke-width="2"
                class="plus-vertical"
                stroke-linejoin="round" />
            </svg>
          </div>
        </div>
        <div class="pa-div">
          <div class="pa-eat-store">
            {% for item in product.metafields.custom.how_to_store_eat.value %}
              <div class="paes-item">
                <div class="paes-icon">
                  <img src="{{ item.icon |  img_url: 'master' }}" alt="{{ item.field_title_optional }}">
                </div>
                <p>{{ item.body }}</p>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% comment %} Seasonal Information {% endcomment %}
      <div class="pa-item">
        <div class="pa-ques-wrap">
          <div class="pa-ques">
            {{ section.settings.acc_2 }}
          </div>
          <div class="pa-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none">
              <path
                d="M12 8V16"
                stroke="#202322"
                stroke-width="2"
                class="plus-horizontal"
                stroke-linejoin="round" />
              <path
                d="M8 12H16"
                stroke="#202322"
                stroke-width="2"
                class="plus-vertical"
                stroke-linejoin="round" />
            </svg>
          </div>
        </div>
        <div class="pa-div">
          <div class="pa-seasons">
            <div class="pas-month">
              {%- assign month_names = "January,February,March,April,May,June,July,August,September,October,November,December" | split: ',' -%}
              {%- assign used_months = product.metafields.custom.country_season.value.season.value.high_season_month | split: ',' -%}
              {%- assign not_months = product.metafields.custom.country_season.value.season.value.low_season_month | split: ',' -%}
              {%- for month in month_names -%}
                {%- assign trimmed_month = month | strip -%}
                <div class="month-in{% if used_months contains trimmed_month %} high-season{% elsif not_months contains trimmed_month %} low-season{% endif %}">
                  <p>{{ trimmed_month | strip_html | truncate: 3, "" }}</p>
                  <div class="month-pill"></div>
                </div>
              {%- endfor -%}
            </div>
            <div class="pas-country">
              <p>{{ product.metafields.custom.country_of_origin.value.country_name }}</p>
              <div class="pas-shipping">
                {% if product.metafields.custom.shipped_by == 'air' %}
                  {% render 'air' %}
                  Shipped by {{ product.metafields.custom.shipped_by }}
                {% elsif product.metafields.custom.shipped_by == 'sea' %}
                  {% render 'sea' %}
                  Shipped by {{ product.metafields.custom.shipped_by }}
                {% elsif product.metafields.custom.shipped_by == 'road' %}
                  {% render 'road' %}
                  Shipped by {{ product.metafields.custom.shipped_by }}
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      {% comment %} Taste Profile {% endcomment %}
      <div class="pa-item">
        <div class="pa-ques-wrap">
          <div class="pa-ques">
            {{ section.settings.acc_3 }}
          </div>
          <div class="pa-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none">
              <path
                d="M12 8V16"
                stroke="#202322"
                stroke-width="2"
                class="plus-horizontal"
                stroke-linejoin="round" />
              <path
                d="M8 12H16"
                stroke="#202322"
                stroke-width="2"
                class="plus-vertical"
                stroke-linejoin="round" />
            </svg>
          </div>
        </div>
        <div class="pa-div">
          <div class="pad-taste-profile">
            {% comment %} Texture {% endcomment %}
            <div class="profile-in">
              <p class="tp-head texture">
                Texture
              </p>
              <div class="tp-wrap">
                {% assign texture_limit = product.metafields.custom.taste_profile.value.texture %}
                <p class="tp-profile">
                  Silky
                </p>
                <div class="tp-pill-in texture">
                  {% for i in (1..5) %}
                    <div class="taste-pill {% if i <= texture_limit %}active{% endif %}"></div>
                  {% endfor %}
                </div>
                <p class="tp-profile">
                  Crunchy
                </p>
              </div>
            </div>
            {% comment %} Sweetness {% endcomment %}
            <div class="profile-in">
              <p class="tp-head sweetness">
                Sweetness
              </p>
              <div class="tp-wrap">
                {% assign sweetness_limit = product.metafields.custom.taste_profile.value.sweetness %}
                <p class="tp-profile">Delicate</p>
                <div class="tp-pill-in sweetness">
                  {% for i in (1..5) %}
                    <div class="taste-pill {% if i <= sweetness_limit %}active{% endif %}"></div>
                  {% endfor %}
                </div>
                <p class="tp-profile">Syrupy</p>
              </div>
            </div>
            {% comment %} Sourness {% endcomment %}
            <div class="profile-in">
              <p class="tp-head sourness">
                Sourness
              </p>
              <div class="tp-wrap">
                {% assign sourness_limit = product.metafields.custom.taste_profile.value.sourness %}
                <p class="tp-profile">Smooth</p>
                <div class="tp-pill-in sourness">
                  {% for i in (1..5) %}
                    <div class="taste-pill {% if i <= sweetness_limit %}active{% endif %}"></div>
                  {% endfor %}
                </div>
                <p class="tp-profile">Zesty</p>
              </div>
            </div>
            {% comment %} Juiciness {% endcomment %}
            <div class="profile-in">
              <p class="tp-head juiciness">
                Juiciness
              </p>
              <div class="tp-wrap">
                {% assign juiciness_limit = product.metafields.custom.taste_profile.value.juiciness %}
                <p class="tp-profile">Firm</p>
                <div class="tp-pill-in juiciness">
                  {% for i in (1..5) %}
                    <div class="taste-pill {% if i <= juiciness_limit %}active{% endif %}"></div>
                  {% endfor %}
                </div>
                <p class="tp-profile">Bursty</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% assign deliveryBlock = section.blocks | where: 'type', 'delivery-info' | first %}
  <div class="product_delivery_modal_container modal fade">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="delivery-cost-title">How much does delivery cost and how long does it take?</h5>
          <button
            type="button"
            class="close"
            data-dismiss="modal"
            aria-label="Close">
            <svg
              width="15px"
              height="15px"
              fill="none"
              class="icon icon-close"
              viewBox="0 0 18 17">
              <path fill="#000" d="M.865 15.978a.5.5 0 0 0 .707.707l7.433-7.431 7.579 7.282a.501.501 0 0 0 .846-.37.5.5 0 0 0-.153-.351L9.712 8.546l7.417-7.416a.5.5 0 1 0-.707-.708L8.991 7.853 1.413.573a.5.5 0 1 0-.693.72l7.563 7.268z" />
            </svg>
          </button>
        </div>
        <div class="modal-body" data-load="/en/_faq/42/delivery-cost">
          <div>
            <p style='margin:0;'>
              <span class="product_delivery_modal_deliver_to">Deliver to</span>
              {{ localization.country }}:
              <span class="calculated-delivery-date-price">9,90 €</span>
            </p>
            <p style='margin:0;'>
              <span class="product_delivery_modal_order_today">Order today to get it from</span>
              <span class="calculated-delivery-date"></span>
            </p>
          </div>
          {{ deliveryBlock.settings.page.content }}
        </div>
      </div>
    </div>
</div> 


<script>
/* ======================================================
   GLOBAL MONEY FORMATTER (USED EVERYWHERE)
====================================================== */
window.formatMoneySafe = function (cents) {
  if (typeof cents !== 'number') return '';
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: Shopify?.currency?.active || '{{ shop.currency }}',
    minimumFractionDigits: 2
  }).format(cents / 100);
};
</script>


<script>
/* ======================================================
   QUANTITY CONTROLLER (NO PRICE LOGIC HERE)
====================================================== */
document.addEventListener('DOMContentLoaded', () => {
  const qtyInput = document.getElementById('Quantity');
  if (!qtyInput) return;

  document.querySelectorAll('.qty-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      let qty = parseInt(qtyInput.value, 10) || 1;
      qty = btn.dataset.action === 'increase' ? qty + 1 : Math.max(1, qty - 1);
      qtyInput.value = qty;
      document.dispatchEvent(new Event('quantity:change'));
    });
  });

  qtyInput.addEventListener('change', () => {
    document.dispatchEvent(new Event('quantity:change'));
  });
});
</script>

<script>
/* ======================================================
   ADD TO CART LOADING + SUCCESS STATE
====================================================== */
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('add-to-cart');
  const form = document.getElementById('product-form');

  if (!btn || !form) return;

  btn.addEventListener('click', async () => {
    if (btn.classList.contains('loading')) return;

    const variantId = form.querySelector('input[name="id"]').value;
    const qty = form.querySelector('#Quantity')?.value || 1;

    // LOADING STATE
    btn.classList.remove('success');
    btn.classList.add('loading');

    try {
      const res = await fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          id: variantId,
          quantity: qty
        })
      });

      if (!res.ok) throw new Error('Add to cart failed');

      await res.json();

      // SUCCESS STATE
      btn.classList.remove('loading');
      btn.classList.add('success');

      // optional: notify cart drawer
      document.dispatchEvent(new Event('cart:refresh'));

      // reset after delay
      setTimeout(() => {
        btn.classList.remove('success');
      }, 1500);

    } catch (err) {
      console.error(err);
      btn.classList.remove('loading');
      alert('Could not add product. Please try again.');
    }
  });
});
</script>


<script defer>
/* ======================================================
   VARIANT SELECTOR (SINGLE SOURCE OF TRUTH)
====================================================== */
class VariantSelector extends HTMLElement {
  constructor() {
    super();
    this.addEventListener('click', this.onVariantClick.bind(this));
  }

  connectedCallback() {
    const urlParams = new URLSearchParams(window.location.search);
    const initialVariantId =
      Number(urlParams.get('variant')) || {{ selected_variant.id }};

    const variants = this.getVariantJSON();
    this.currentVariant = variants.find(v => v.id === initialVariantId);
    if (!this.currentVariant) return;

    /* Sync active UI */
    this.currentVariant.options.forEach((value, index) => {
      const ul = this.querySelectorAll('.variant-values')[index];
      if (!ul) return;
      ul.querySelectorAll('.variant-value').forEach(li => {
        li.classList.toggle('active', li.dataset.value === value);
      });
    });

    this.updateFormID();
    this.updatePriceInstant();
    this.updateAddToCartButton();

    document.addEventListener('quantity:change', () => {
      this.updateAddToCartButton();
    });
  }

  onVariantClick(e) {
    const clickedLi = e.target.closest('.variant-value');
    if (!clickedLi) return;

    const parentUl = clickedLi.closest('.variant-values');
    parentUl.querySelectorAll('.variant-value').forEach(li =>
      li.classList.remove('active')
    );
    clickedLi.classList.add('active');

    this.getSelectedOptions();
    this.getSelectedVariant();
    if (!this.currentVariant) return;

    this.updateURL();
    this.updateFormID();
    this.updatePriceInstant();
    this.updateAddToCartButton();
  }

  /* ---------- Helpers ---------- */

  getVariantJSON() {
    return (
      this.variantData ||
      (this.variantData = JSON.parse(
        this.querySelector('[type="application/json"]').textContent
      ))
    );
  }

  getSelectedOptions() {
    this.options = Array.from(this.querySelectorAll('.variant-values'))
      .map(ul => ul.querySelector('.variant-value.active')?.dataset.value)
      .filter(Boolean);
  }

  getSelectedVariant() {
    const variants = this.getVariantJSON();
    this.currentVariant = variants.find(v =>
      v.options.every((opt, i) => opt === this.options[i])
    );
  }

  updateURL() {
    window.history.replaceState(
      {},
      '',
      `${this.dataset.url}?variant=${this.currentVariant.id}`
    );
  }

  updateFormID() {
    const input = document.querySelector('#product-form input[name="id"]');
    if (input) input.value = this.currentVariant.id;
  }

  updatePriceInstant() {
    const priceWrap = document.getElementById('price-{{ section.id }}');
    if (!priceWrap) return;

    const { price, compare_at_price } = this.currentVariant;

    priceWrap.innerHTML = `
      ${compare_at_price && compare_at_price > price
        ? `<strike class="real-price">${formatMoneySafe(compare_at_price)}</strike>`
        : ''}
      <span class="sell-price">${formatMoneySafe(price)}</span>
      <span class="price-txt">Taxes, Excl. shipping</span>
    `;

    const perKg = document.querySelector('.perKg');
    if (perKg) {
      if (this.currentVariant.unit_price_measurement) {
        perKg.textContent =
          formatMoneySafe(this.currentVariant.unit_price) +
          ' / ' +
          this.currentVariant.unit_price_measurement.reference_unit;
      } else {
        perKg.textContent =
          formatMoneySafe(this.currentVariant.price) + ' / unit';
      }
    }
  }

  updateAddToCartButton() {
    const btn = document.getElementById('add-to-cart');
    const qtyInput = document.getElementById('Quantity');
    if (!btn || !qtyInput) return;

    const qty = parseInt(qtyInput.value, 10) || 1;
    btn.querySelector('.btn-price').textContent =
      formatMoneySafe(this.currentVariant.price * qty);

    btn.disabled = !this.currentVariant.available;
  }
}

customElements.define('variant-selector', VariantSelector);
</script>


<script>
/* ======================================================
   URL FALLBACK (KEEP YOUR EXISTING BEHAVIOR)
====================================================== */
document.addEventListener('DOMContentLoaded', () => {
  const hasVariant = new URLSearchParams(window.location.search).has('variant');
  const defaultVariantId = {{ default_variant.id }};

  if (!hasVariant) {
    const url = new URL(window.location.href);
    url.searchParams.set('variant', defaultVariantId);
    window.history.replaceState({}, '', url.toString());
  }
});
</script>


<script>
/* ======================================================
   SLICK SLIDER (UNCHANGED)
====================================================== */
$(document).ready(function () {
  $('.prod-main-image').slick({
    slidesToShow: 1,
    slidesToScroll: 1,
    arrows: false,
    fade: true,
    asNavFor: '.prod-thumb-image',
  });

  $('.prod-thumb-image').slick({
    slidesToShow: 4,
    slidesToScroll: 1,
    asNavFor: '.prod-main-image',
    focusOnSelect: true,
    centerMode: true,
    vertical: true,
    arrows: false,
  });

  $('.custom-prev').click(() => $('.prod-main-image').slick('slickPrev'));
  $('.custom-next').click(() => $('.prod-main-image').slick('slickNext'));
});
</script>


<script>
/* ======================================================
   ACCORDION (UNCHANGED)
====================================================== */
$(document).on('click', '.pa-ques-wrap', function () {
  const $item = $(this).closest('.pa-item');
  const $content = $item.find('.pa-div');

  if ($item.hasClass('active')) {
    $item.removeClass('active');
    $content.slideUp(300);
    return;
  }

  $('.pa-item').removeClass('active');
  $('.pa-div').slideUp(300);

  $item.addClass('active');
  $content.slideDown(300);
});
</script>


<script>
/* ======================================================
   OFFER COPY (UNCHANGED)
====================================================== */
document.addEventListener('click', function (e) {
  const btn = e.target.closest('.offer-copy-btn');
  if (!btn) return;

  navigator.clipboard.writeText(btn.dataset.code).then(() => {
    btn.textContent = 'Copied';
    btn.classList.add('copied');

    setTimeout(() => {
      btn.textContent = 'Copy';
      btn.classList.remove('copied');
    }, 2000);
  });
});
</script>



{% schema %}
  {
    "name": "Product",
    "blocks": [
      {
        "type": "title",
        "name": "Title",
        "limit": 1,
        "settings": [
          {
            "type": "checkbox",
            "id": "show_testimonial",
            "label": "Show Title Testimonial",
            "default": true
          }, {
            "type": "richtext",
            "id": "title_testimonial",
            "label": "Testimonial Above Tilte"
          }
        ]
      },
      {
        "type": "product_usp",
        "name": "Product Usp",
        "limit": 1
      },
      {
        "type": "product_info",
        "name": "Product Information",
        "limit": 1
      },
      
      {
        "type": "store_usp",
        "name": "Store USP",
        "limit": 1,
        "settings": [
          {
            "type": "image_picker",
            "id": "shipping_usp_icon",
            "label": "Shipping USP Icon"
          },
          {
            "type": "page",
            "id": "shipping_usp_page",
            "label": "Shipping Page"
          },
          {
            "type": "text",
            "id": "shipping_usp_text",
            "label": "Shipping USP Text"
          },
          {
            "type": "image_picker",
            "id": "freshness_icon",
            "label": "Freshness Icon"
          }, {
            "type": "text",
            "id": "freshness_text",
            "label": "Freshness Text"
          }, {
            "type": "image_picker",
            "id": "payment_usp_icon",
            "label": "Payment USP Icon"
          }, {
            "type": "text",
            "id": "payment_usp_text",
            "label": "Payment USP Text"
          }
        ]
      }, 
      {
        "type": "variant_selector",
        "name": "Variant Selector",
        "limit": 1
      }, 
      {
        "type": "delivery-info",
        "name": "Delivery information",
        "settings": [
          {
            "type": "text",
            "id": "delivery_message",
            "label": "Delivery message",
            "default": "Max. freshness, min. waste — we harvest after you order."
          }, {
            "type": "text",
            "id": "popup_button",
            "label": "Popup button text",
            "default": "click here to get delivery information (cost, delay)"
          }, {
            "type": "page",
            "id": "page",
            "label": "Modal content"
          }
        ]
      },
      {
        "type": "offer",
        "name": "Offer / Coupon",
        "settings": [
          {
            "type": "text",
            "id": "code",
            "label": "Coupon Code",
            "default": "JURASSIC222"
          },
          {
            "type": "text",
            "id": "text",
            "label": "Offer Text",
            "default": "Buy 3 @ $350 + Free Gifts"
          }
        ]
      },
      {
          "type": "@app"
      }
    ],
    "settings": [
      {
        "type": "text",
        "id": "acc_1",
        "label": "Accordion 1 Label",
        "default": "How to eat & Store"
      }, {
        "type": "text",
        "id": "acc_2",
        "label": "Accordion 2 Label",
        "default": "Seasonal Calendar - fruit origin"
      }, {
        "type": "text",
        "id": "acc_3",
        "label": "Accordion 3 Label",
        "default": "taste profile"
      }
    ]
  }
{% endschema %}