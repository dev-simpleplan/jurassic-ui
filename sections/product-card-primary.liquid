{% assign default_variant = nil %}

{% for variant in product.variants %}
  {% if variant.metafields.custom.is_prior == true and variant.available %}
    {% assign default_variant = variant %}
    {% break %}
  {% endif %}
{% endfor %}

{% if default_variant == nil %}
  {% for variant in product.variants %}
    {% if variant.available %}
      {% assign default_variant = variant %}
      {% break %}
    {% endif %}
  {% endfor %}
{% endif %}

{% if default_variant == nil %}
  {% assign default_variant = product.variants.first %}
{% endif %}

<div class="product-card-primary">
  <div class="fruits_card">
      <div class="fc_top">
        <a href="{{ product.url }}" class="card-link"></a>
        {% assign images = product.images %}

        <div class="fc_image">
          {% if images.size > 0 %}
            <img
              src="{{ images.first | img_url: 'master' }}"
              alt="{{ product.title | escape }}"
              class="img_sizing primary-img">

            {% if images.size > 1 %}
              <img
                src="{{ images[1] | img_url: 'master' }}"
                alt="{{ product.title | escape }}"
                class="img_sizing hover-img">
            {% endif %}
          {% else %}
            <img
              src="{{ 'https://cdn.shopify.com/s/files/1/0752/8015/4881/files/jf-placeholder.png?v=1769522647' }}"
              alt="No Image Available"
              class="img_sizing primary-img">
          {% endif %}
        </div>


        {% assign product_tags = product.tags | downcase %}
        {% if product.tags.size > 0 %}
          <div class="fc_category_tags">
            {% for tag in product.tags %}
              {% unless tag == 'Best Seller' %}
                <span>{{ tag }}</span>
              {% endunless %}
            {% endfor %}
          </div>
        {% endif %}

        {% if product.tags contains 'Best Seller' %}
          <div class="fc_bestsell_tags">
            <span>Bestseller</span>
          </div>
        {% endif %}

        {% if product.metafields.custom.certificate %}
          {% assign certificate = product.metafields.custom.certificate.value %}
          {% for item in product.metafields.custom.certificate.value %}
            <div class="fc_organic_auth">
              <img
                src="{{ item.badge_image | img_url:'master' }}"
                alt="{{ item.display_name }}"
                class="img_sizing">
            </div>
          {% endfor %}
        {% endif %}
      </div>

    <div class="fc_bottom_outer">
      <div class="fc_bottom">

        <div class="fc_bottom_top">
          <div class="star_review">
            <div class="star_rating">
              <p data-oke-star-rating data-oke-reviews-product-id="shopify-{{ product.id }}"></p>
            </div>
            <div class="rating_info">
              <span class="dot_seperator dynamic-review-dot"></span>
              <p>{{ product.metafields.custom.country_of_origin.value.country_name }}</p>
            </div>
          </div>
          <p class="fc_product_title">
            <a href="{{ product.url }}">{{ product.title | truncate: 50 }}</a>
          </p>
          
        </div>

        <div class="fc_bottom_bottom">
          <div class="fc_bottom_center">
            <div class="fc_variant_outer">
              <div class="fc_variant_wrap">
                {% for variant in product.variants %}
                  <script type="application/JSON">
                    {{ variant | json }}
                  </script>

                  {% assign pieces = 0 %}
                  {% if variant.unit_price_measurement
                    and variant.unit_price_measurement.quantity_value != blank %}
                    {% assign pieces = variant.unit_price_measurement.quantity_value | round %}
                  {% endif %}

                  <div
                    class="fc_variant_item
                    {% if variant.id == default_variant.id %}active{% endif %}
                    {% if variant.metafields.custom.bestseller == true %}bestseller{% endif %}"
                    data-id="{{ variant.id }}"
                    data-price="{{ variant.price | money }}"
                    data-compare="{{ variant.compare_at_price | money }}"
                    data-inventory="{{ variant.inventory_quantity }}"
                    data-unit="{% if variant.unit_price_measurement %}
                      {{ variant.unit_price | money }} / {{ variant.unit_price_measurement.reference_unit }}
                    {% else %}
                      {{ variant.price | money }} / unit
                    {% endif %}"
                    data-image="{{ variant.image | img_url: 'master' }}">
                    {% if variant.metafields.custom.bestseller == true %}
                      <div class="vv-bestseller">Bestseller</div>
                    {% endif %}
                    <p class="weight">
                      {{ variant.title }}
                      {% if variant.compare_at_price > variant.price %}
                        <span>
                          {{
                            variant.compare_at_price | minus: variant.price | times: 100 | divided_by: variant.compare_at_price | round
                          -}}
                          % Off
                        </span>
                      {% endif %}
                    </p>
                    <p class="quantity">
                      {% if variant.unit_price_measurement
                        and variant.unit_price_measurement.quantity_value != blank %}
                        
                        {% assign pieces = variant.unit_price_measurement.quantity_value | round %}
                        
                        {{ pieces }}
                        {% if pieces == 1 %} Peice{% else %} Peices{% endif %}
                        
                      {% else %}
                        0 Peices
                      {% endif %}
                    </p>

                  </div>
                {% endfor %}
              </div>
              <div class="selected_variant_dropdown"></div>
            </div>
          </div>

          <div class="fc_bottom_end">
            <div class="fc_price_weight">
              {% assign current_variant = nil %}
              {% assign current_variant = default_variant %}

              {% if current_variant.compare_at_price > current_variant.price %}
                <p>
                  <strike id="compare_price">{{ current_variant.compare_at_price | money }}</strike>
                  <span class="selling_price">{{ current_variant.price | money }}</span>
                </p>
              {% else %}
                <p>
                  <span class="selling_price">{{ current_variant.price | money }}</span>
                </p>
              {% endif %}

              <p class="fc_weight">
                {% if current_variant.unit_price_measurement
                  and current_variant.unit_price_measurement.reference_unit != 'kg' %}
                  
                  {{ current_variant.unit_price | money }} /
                  {{ current_variant.unit_price_measurement.reference_unit }}

                {% elsif current_variant.unit_price_measurement == blank %}
                  
                  {{ current_variant.price | money }} / piece

                {% else %}
                  
                  {{ current_variant.price | money }} / piece

                {% endif %}
              </p>


            </div>
            <div class="fc_add_to_cart_outer">
                <div class="fc_add_to_cart"
                  data-variant-id="{{ current_variant.id }}"
                  data-available="{{ current_variant.available }}"
                  data-inventory="{{ current_variant.inventory_quantity }}"
                  data-external-add>

                  <button
                    type="button"
                    class="add-to-cart-btn"
                    {% unless current_variant.available %}disabled{% endunless %}>
                    {% if current_variant.available %}Add to Cart{% else %}Sold Out{% endif %}
                  </button>

                </div>
            </div>
            <div class="fc_trust_text">
              <p>Only {{ current_variant.inventory_quantity }} Left</p>
              <span class="dot_seperator"></span>
              <p>Ships in 24 hrs</p>
              <span class="dot_seperator"></span>
              <p>{{ product.metafields.custom.benefit | default: 'Product Benefit' }}</p>
            </div>
          </div>
        </div>


      </div>
    </div>
  </div>
</div>

  <script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.product-card-primary').forEach(card => {
    if (window.initCardCartLogic) {
      window.initCardCartLogic(card);
    }

    const addBtn = card.querySelector('.add_product');
    const removeBtn = card.querySelector('.remove_product');
    const container = card.querySelector('.fc_add_to_cart');

    if (addBtn && removeBtn && container) {
      removeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const variantId = container.dataset.variantId;
        const qtyDisplay = container.querySelector('.qty-value');
        const currentQty = parseInt(qtyDisplay.innerText);
        
        // Prevent negative quantities
        const newQty = currentQty > 0 ? currentQty - 1 : 0;
        
        if (window.updateCartItem) {
           window.updateCartItem(null, newQty, variantId); 
        }
      });

      addBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const variantId = container.dataset.variantId;
        const qtyDisplay = container.querySelector('.qty-value');
        const currentQty = parseInt(qtyDisplay.innerText);
        
        const newQty = currentQty + 1;
        
        if (window.updateCartItem) {
          window.updateCartItem(null, newQty, variantId); 
        }
      });
    }
  });
});
</script>

<script>
(function() {
  const checkOkendoRating = () => {
    const containers = document.querySelectorAll('.star_review');
    
    containers.forEach(container => {
      const dot = container.querySelector('.dynamic-review-dot');
      const jsonData = container.querySelector('script[type="application/json"]');
      
      if (jsonData && dot) {
        try {
          const data = JSON.parse(jsonData.innerHTML);
          // If review count is greater than 0, show the dot
          if (data.reviewCount > 0) {
            dot.style.setProperty('display', 'inline-block', 'important');
          } else {
            dot.style.setProperty('display', 'none', 'important');
          }
        } catch (e) {
          // If JSON isn't ready, keep it hidden
          dot.style.display = 'none';
        }
      }
    });
  };

  // Run the check frequently for the first few seconds while Okendo loads
  const timer = setInterval(checkOkendoRating, 500);
  
  // Stop checking after 5 seconds to save performance
  setTimeout(() => clearInterval(timer), 5000);

  // Also run on window load
  window.addEventListener('load', checkOkendoRating);
})();
</script>